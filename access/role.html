<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Select Role â€“ Naveo FSM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="/assets/js/noco.js"></script>
  <script src="/assets/js/auth-lite.js"></script>
  <style>
    :root{--primary:#0056b3;--bg:#f5f7fb;--card:#fff;--border:#e5e7eb}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:Poppins, Arial, sans-serif}
    .wrap{max-width:560px;margin:8vh auto;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.06);padding:22px}
    h1{margin:.2rem 0 1rem;font-size:20px}
    .row{margin:10px 0}
    .btn{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    select,input[type=radio]{cursor:pointer}
    .muted{color:#6b7280;font-size:.9rem}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Choose your role</h1>

    <div class="row">
      <label><input type="radio" name="role" value="planner" checked /> Planner</label>
      &nbsp;&nbsp;&nbsp;
      <label><input type="radio" name="role" value="technician" /> Technician</label>
    </div>

    <div id="techPicker" class="row" style="display:none;">
      <label style="font-weight:600;display:block;margin-bottom:6px;">Select Technician</label>
      <select id="technician_id" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:10px"></select>
      <div class="muted" style="margin-top:6px;">This sets which technician the app acts as.</div>
    </div>

    <div class="row" style="display:flex;gap:8px;align-items:center;margin-top:16px;">
      <button id="enterBtn" class="btn">Enter</button>
      <div id="msg" class="muted"></div>
    </div>
  </div>

  <script>
    const { T } = NC, api = NCAPI;

    const LANDING = {
      planner: '/planner/planner-jobs.html',
      technician: '/technician/home.html' // TODO: change to your tech app home when ready
    };

    function setTechPickerVisible(on){ document.getElementById('techPicker').style.display = on ? '' : 'none'; }

    // role toggle
    document.querySelectorAll('input[name=role]').forEach(r=>{
      r.onchange = ()=> setTechPickerVisible(r.value === 'technician');
    });

    // load technicians for picker
    async function loadTechs(){
      try{
        const res = await api.list(T.technicians, 'limit=1000&select=id,full_name,email_address');
        const sel = document.getElementById('technician_id');
        sel.innerHTML = res.list.map(t=> `<option value="${t.id}">${t.full_name || t.email_address || ('Tech #'+t.id)}</option>`).join('');
      }catch(e){
        document.getElementById('msg').textContent = 'Error loading technicians';
        console.error(e);
      }
    }

    document.getElementById('enterBtn').onclick = ()=>{
      const role = document.querySelector('input[name=role]:checked').value;
      if(role === 'technician'){
        const sel = document.getElementById('technician_id');
        if(!sel.value) { document.getElementById('msg').textContent = 'Please select a technician.'; return; }
        const tech = { id: +sel.value, name: sel.options[sel.selectedIndex].text };
        Auth.setRole('technician', tech);
      } else {
        Auth.setRole('planner');
      }
      const url = LANDING[role] || '/';
      window.location.href = url;
    };

    // init
    (async function(){
      setTechPickerVisible(false);
      await loadTechs();
    })();
  </script>
</body>
</html>

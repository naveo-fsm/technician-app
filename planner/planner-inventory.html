<!DOCTYPE html>
<html lang="en">
<head>
  <script src="../assets/js/auth.js"></script>
  <meta charset="UTF-8" />
  <title>Planner - Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 1.5rem; background: #f8f9fa; }
    h2 { color: #003366; margin-bottom: 1rem; }
    .filters { margin-bottom: 1rem; }
    .filters label, .filters select, .filters input, .filters button {
      margin-right: .5rem; margin-bottom: .5rem;
    }
    .btn { background: #007bff; color: white; border: none; padding: .4rem .8rem; border-radius: 4px; cursor: pointer; }
    .btn:hover { background: #0056b3; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #e8e8e8; cursor: pointer; }
    .pagination { margin-top: 1rem; }
    .page-btn { padding: 5px 10px; margin: 2px; background: #ddd; border: none; cursor: pointer; }
    .page-btn.active { background: #007bff; color: white; }
    @media screen and (max-width: 768px) {
      table, thead, tbody, th, td, tr { display: block; }
      thead tr { position: absolute; top: -9999px; left: -9999px; }
      tr { border: 1px solid #ccc; margin-bottom: .5rem; }
      td { border: none; border-bottom: 1px solid #eee; position: relative; padding-left: 50%; }
      td::before { position: absolute; top: 6px; left: 6px; width: 45%; padding-right: 10px; white-space: nowrap; font-weight: bold; }
      td:nth-of-type(1)::before { content: "Date"; }
      td:nth-of-type(2)::before { content: "Item"; }
      td:nth-of-type(3)::before { content: "Make"; }
      td:nth-of-type(4)::before { content: "Model"; }
      td:nth-of-type(5)::before { content: "Serial #"; }
      td:nth-of-type(6)::before { content: "SIM #"; }
      td:nth-of-type(7)::before { content: "Technician"; }
      td:nth-of-type(8)::before { content: "Consumed"; }
    }
  </style>
</head>
<body>
  <h2>ðŸ“¦ Inventory Overview</h2>

  <div class="filters">
    <label for="techFilter">Technician:</label>
    <select id="techFilter"><option value="">All</option></select>

    <label for="fromDate">From:</label>
    <input type="date" id="fromDate">

    <label for="toDate">To:</label>
    <input type="date" id="toDate">

    <button class="btn" onclick="applyFilters()">Apply</button>
    <button class="btn" onclick="exportCSV()">Export CSV</button>
    <button class="btn" onclick="exportPDF()">Export PDF</button>
  </div>

  <table id="inventoryTable">
    <thead>
      <tr>
        <th onclick="sortTable(0)">Date</th>
        <th onclick="sortTable(1)">Item</th>
        <th onclick="sortTable(2)">Make</th>
        <th onclick="sortTable(3)">Model</th>
        <th onclick="sortTable(4)">Serial Number</th>
        <th onclick="sortTable(5)">SIM Number</th>
        <th onclick="sortTable(6)">Technician</th>
        <th onclick="sortTable(7)">Consumed</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="pagination" id="pagination"></div>

  <script>
    const BASE = "https://sheetdb.io/api/v1/xg2dgvssxzvag";
    const INV_SHEET = "?sheet=Inventory_Consumed";
    const TECH_SHEET = "?sheet=Technicians";

    let allData = [], filtered = [], rawTechs = [];
    let currentPage = 1, rowsPerPage = 10;
    let sortIndex = -1, sortAsc = true;

    // Fetch both sheets, then init
    async function init() {
      [allData, rawTechs] = await Promise.all([
        fetchJSON(BASE + INV_SHEET),
        fetchJSON(BASE + TECH_SHEET)
      ]);
      populateTechFilter();
      filtered = [...allData];
      renderTable();
    }

    function fetchJSON(url) {
      return fetch(url).then(r => {
        if (!r.ok) throw new Error(r.statusText);
        return r.json();
      });
    }

    function populateTechFilter() {
      const sel = document.getElementById("techFilter");
      rawTechs.forEach(t => {
        const o = document.createElement("option");
        o.value = t.TechnicianID;
        o.textContent = t.FullName;
        sel.append(o);
      });
    }

    function applyFilters() {
      const tech = document.getElementById("techFilter").value;
      const from = document.getElementById("fromDate").value;
      const to   = document.getElementById("toDate").value;
      filtered = allData.filter(d => {
        if (tech && d.TechnicianID !== tech) return false;
        if (from && d.Date < from) return false;
        if (to   && d.Date > to)   return false;
        return true;
      });
      currentPage = 1;
      renderTable();
    }

    function renderTable() {
      const start = (currentPage-1)*rowsPerPage, end = start+rowsPerPage;
      const view = filtered.slice(start,end);
      const tbody = document.querySelector("#inventoryTable tbody");
      tbody.innerHTML = "";
      view.forEach(d => {
        tbody.innerHTML += `
          <tr>
            <td>${d.Date}</td>
            <td>${d.Item}</td>
            <td>${d.Make}</td>
            <td>${d.Model}</td>
            <td>${d.SerialNumber}</td>
            <td>${d.SIMNumber}</td>
            <td>${d.TechnicianID}</td>
            <td>${d.Consumed||''}</td>
          </tr>`;
      });
      renderPagination();
    }

    function renderPagination() {
      const totalPages = Math.ceil(filtered.length/rowsPerPage);
      const container = document.getElementById("pagination");
      container.innerHTML = "";
      for (let i=1; i<=totalPages; i++){
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = "page-btn" + (i===currentPage? " active":"");
        btn.onclick = ()=>{ currentPage=i; renderTable(); };
        container.append(btn);
      }
    }

    function sortTable(idx) {
      const keys = ["Date","Item","Make","Model","SerialNumber","SIMNumber","TechnicianID","Consumed"];
      const key = keys[idx];
      if (sortIndex===idx) sortAsc = !sortAsc;
      else { sortAsc=true; sortIndex=idx; }
      filtered.sort((a,b)=>
        sortAsc
          ? (a[key]||'').localeCompare(b[key]||'')
          : (b[key]||'').localeCompare(a[key]||'')
      );
      currentPage = 1;
      renderTable();
    }

    // CSV export
    function exportCSV() {
      const rows = [
        ["Date","Item","Make","Model","SerialNumber","SIMNumber","Technician","Consumed"],
        ...filtered.map(d=>[
          d.Date, d.Item, d.Make, d.Model, d.SerialNumber,
          d.SIMNumber, d.TechnicianID, d.Consumed||''
        ])
      ];
      const csv = rows.map(r=>r.map(c=>`"${c}"`).join(",")).join("\r\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "inventory.csv";
      a.click();
    }

    // PDF export
    async function exportPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ orientation: "landscape" });
      pdf.setFontSize(14);
      pdf.text("Inventory Report",14,16);
      const cols = ["Date","Item","Make","Model","Serial#","SIM#","Technician","Consumed"];
      const rows = filtered.map(d=>[
        d.Date,d.Item,d.Make,d.Model,d.SerialNumber,
        d.SIMNumber,d.TechnicianID,d.Consumed||''
      ]);
      pdf.autoTable({ startY:24, head:[cols], body:rows });
      pdf.save("inventory.pdf");
    }

    // load on open
    init().catch(e=>alert("Error loading inventory: "+e));
  </script>

  <!-- include autoTable plugin for jspdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
</body>
</html>

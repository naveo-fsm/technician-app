<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Naveo FSM ‚Äî Live Map + ETA</title>
  <!-- Global stylesheet -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/naveo.css">
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    .toolbar { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .grow { flex:1 1 auto; }
    .map-wrap{ height: calc(100vh - 140px); border:1px solid var(--border); border-radius: var(--radius-lg); overflow:hidden; background: var(--surface); }
    #map { height: 100%; width:100%; }
    .legend { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .dot { width:10px; height:10px; border-radius:999px; display:inline-block; }
    .dot.tech{ background:#5a8dee; }
    .dot.job{ background:#e0a200; }
    .dot.trail{ background:#9b59b6; }
    .dot.eta{ background:#2ecc71; }
    .pill { display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border); border-radius:999px; padding:4px 10px; }
    .mini { font-size: var(--text-sm); color: var(--text-muted); }
    .leaflet-popup-content { margin: 8px 12px; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Naveo FSM</div>
    <span class="muted">Live Map</span>
    <div class="grow"></div>
    <button class="btn" id="btnSettings" title="NocoDB settings">‚öôÔ∏è Settings</button>
  </div>

  <aside class="sidebar">
    <div class="brand">Naveo</div>
    <a href="dashboard.html">Dashboard</a>
    <a href="planner.html">Planner</a>
    <a href="planner-jobs.html">Service Orders</a>
    <a href="assign-job-enhanced.html">Assign Job</a>
    <a href="planner-inventory.html">Inventory</a>
    <a href="reports.html">Reports</a>
    <a class="active" href="realtime-map.html">Live Map</a>
    <a href="history.html">History</a>
    <a href="admin-intervention-master.html">Admin ¬∑ Intervention Types</a>
    <a href="admin-tech-master.html">Admin ¬∑ Technicians</a>
  </aside>

  <main class="main">
    <div class="card">
      <div class="card-header">
        <h2>Technicians & Jobs ‚Äî Realtime</h2>
        <div class="toolbar">
          <input id="q" class="input" placeholder="Filter by tech name or SO id‚Ä¶" style="min-width:280px"/>
          <select id="status" class="select">
            <option value="">All SO status</option>
            <option>assigned</option><option>in_progress</option><option>completed</option><option>cancelled</option>
          </select>
          <select id="tech" class="select" style="min-width:200px"><option value="">All technicians</option></select>
          <label class="control-inline"><input type="checkbox" id="showJobs" checked><span>Show jobs</span></label>
          <label class="control-inline"><input type="checkbox" id="showTrails"><span>Show trail on tech click</span></label>
          <div class="pill">
            <span class="mini">Trail</span>
            <select id="trailHours" class="select"><option value="2">2h</option><option value="6">6h</option><option value="12">12h</option><option value="24">24h</option></select>
          </div>
          <div class="pill">
            <span class="mini">ETA speed</span>
            <select id="avgSpeed" class="select">
              <option value="30">30 km/h</option>
              <option value="35">35 km/h</option>
              <option value="40" selected>40 km/h</option>
              <option value="50">50 km/h</option>
              <option value="60">60 km/h</option>
            </select>
          </div>
          <div class="pill">
            <span class="mini">Auto‚Äërefresh</span>
            <select id="refreshEvery" class="select">
              <option value="0">Off</option>
              <option value="5">5s</option>
              <option value="15" selected>15s</option>
              <option value="30">30s</option>
              <option value="60">60s</option>
            </select>
          </div>
          <button class="btn" id="btnRefresh">‚Üª Now</button>
          <button class="btn" id="btnFit">üìç Fit to data</button>
          <div class="grow"></div>
          <div class="legend mini">
            <span class="dot tech"></span> Tech &nbsp; <span class="dot job"></span> Job &nbsp; <span class="dot trail"></span> Trail &nbsp; <span class="dot eta"></span> ETA line
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="map-wrap"><div id="map"></div></div>
      </div>
    </div>
  </main>

  <script>
    // ---------------------- Config -------------------------------------------
    const NC_BASE = localStorage.getItem('NC_BASE') || 'https://app.nocodb.com/api/v2';
    const NC_PAT  = localStorage.getItem('NC_PAT') || '';
    const TBL_TLOC = 'mdau1eojkb8c56x';   // technician_locations
    const TBL_TECH = 'mzw1focsec0tekg';   // technicians
    const TBL_SO   = 'm2dmcyfy30klv76';   // service_orders

    const H = () => ({ 'Content-Type': 'application/json', 'xc-token': NC_PAT });
    const $ = (s, p=document) => p.querySelector(s);

    // ---------------------- Map ----------------------------------------------
    let map, layerTech, layerJobs, layerTrail, layerETA;

    function initMap(){
      map = L.map('map', { zoomControl: true, attributionControl: true }).setView([-20.2, 57.5], 9);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
      layerTech  = L.layerGroup().addTo(map);
      layerJobs  = L.layerGroup().addTo(map);
      layerTrail = L.layerGroup().addTo(map);
      layerETA   = L.layerGroup().addTo(map);
    }

    function fitToData(){
      const g = L.featureGroup([layerTech, layerJobs]);
      try { map.fitBounds(g.getBounds().pad(0.2)); } catch(e){ /* ignore if empty */ }
    }

    // ---------------------- Lookups ------------------------------------------
    let techList = [];
    async function loadTechs(){
      const url = `${NC_BASE}/tables/${TBL_TECH}/records?limit=1000&orderBy=full_name&order=asc`;
      techList = await fetch(url,{headers:H()}).then(r=>r.json());
      $('#tech').innerHTML = '<option value="">All technicians</option>' + techList.map(t=>`<option value="${t.id}">${t.full_name||t.email_address||('Tech #'+t.id)}</option>`).join('');
    }
    const techById = (id)=> techList.find(t=> String(t.id)===String(id));

    // ---------------------- Fetch data ---------------------------------------
    function isoHoursAgo(hours){ const d=new Date(Date.now()-hours*3600*1000); return d.toISOString().slice(0,19); }

    async function fetchLatestLocations(){
      // Get last 48h of pings, reduce to newest per tech
      const url = `${NC_BASE}/tables/${TBL_TLOC}/records?limit=10000&orderBy=recorded_at&order=desc&where=${encodeURIComponent('(recorded_at,ge,'+isoHoursAgo(48)+')')}`;
      const rows = await fetch(url,{headers:H()}).then(r=>r.json());
      const byTech = new Map();
      rows.forEach(r=>{ if(!byTech.has(r.technician_id)) byTech.set(r.technician_id, r); });
      return [...byTech.values()];
    }

    async function fetchOpenJobs(){
      let where = '(status,eq,assigned)~or(status,eq,in_progress)';
      const st = $('#status').value; if(st) where = `(status,eq,${st})`;
      const url = `${NC_BASE}/tables/${TBL_SO}/records?limit=10000&orderBy=scheduled_at&order=asc&where=${encodeURIComponent(where)}`;
      const rows = await fetch(url,{headers:H()}).then(r=>r.json());
      return rows.filter(r=> r.address_lat!=null && r.address_lng!=null);
    }

    // ---------------------- ETA helpers --------------------------------------
    function haversine(lat1, lon1, lat2, lon2){
      const toRad = (v)=> v*Math.PI/180; const R=6371; // km
      const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R*c; // km
    }

    function pickNextJobForTech(techId, jobs){
      const arr = jobs.filter(j=> String(j.technician_id)===String(techId));
      if(!arr.length) return null;
      arr.sort((a,b)=> new Date(a.scheduled_at||'2100-01-01') - new Date(b.scheduled_at||'2100-01-01'));
      return arr[0];
    }

    // Keep last fetched data so we can redraw ETA without refetching
    let lastLocs = []; let lastJobs = []; let lastLocByTech = new Map(); let jobMarkerById = new Map();

    function formatEta(min){
      const m = Math.max(0, Math.round(min)); const h = Math.floor(m/60), mm = m%60;
      return h ? `${h}h ${String(mm).padStart(2,'0')}m` : `${mm} min`;
    }

    // ---------------------- Render markers -----------------------------------
    function markerTech(lat,lng,label,sub,tech,etaInfo){
      const m = L.circleMarker([lat,lng], { radius:8, weight:2, color:'#5a8dee', fillColor:'#5a8dee', fillOpacity:0.9 });
      const phone = tech?.phone? `<div class="mini">üìû ${tech.phone}</div>`: '';
      let etaHtml = '';
      if(etaInfo){
        const { job, distKm, etaMin, lateBy } = etaInfo;
        const sched = job?.scheduled_at ? new Date(job.scheduled_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '‚Äî';
        const status = (lateBy>0) ? `‚ö† likely late by ${lateBy} min` : '‚úì on time';
        etaHtml = `<div class="mini mt-1">Next: <span class="mono">${job.so_id||job.id}</span> ¬∑ ${distKm.toFixed(1)} km ¬∑ ETA ${formatEta(etaMin)} (sched ${sched}) ‚Äî ${status}</div>
                   <div class="mt-2"><button class="btn btn-sm" data-tech="${tech?.id||''}" onclick="window.__drawETA && window.__drawETA(${tech?.id||'null'})">Show ETA line</button></div>`;
      } else {
        etaHtml = `<div class="mini mt-1">No upcoming job</div>`;
      }
      m.bindPopup(`<div class="mono fw-600">${label}</div><div class="mini">${sub||''}</div>${phone}${etaHtml}`);
      return m;
    }
    function markerJob(lat,lng,label,sub,so){
      const m = L.circleMarker([lat,lng], { radius:7, weight:2, color:'#e0a200', fillColor:'#e0a200', fillOpacity:0.85 });
      const pr = (so?.priority||'normal').toLowerCase();
      const st = so?.status||'';
      const tech = techById(so?.technician_id);
      const tname = tech?.full_name || tech?.email_address || (so?.technician_id||'');
      m.bindPopup(`<div class="mono fw-600">${label}</div><div class="mini">${sub||''}</div><div class="mini">${tname}</div><div class="mini">Priority: ${pr} ¬∑ Status: ${st}</div><div class="mt-2"><a class="btn btn-sm" href="planner-jobs.html">Open in list</a></div>`);
      return m;
    }

    function renderTechMarkers(locs, jobs){
      layerTech.clearLayers();
      const q = $('#q').value.trim().toLowerCase();
      const techFilter = $('#tech').value;
      const speed = Number($('#avgSpeed').value||40);
      locs.filter(r=> r.lat!=null && r.lng!=null).forEach(r=>{
        if(techFilter && String(r.technician_id)!==String(techFilter)) return;
        const t = techById(r.technician_id);
        const name = t?.full_name || t?.email_address || ('Tech #'+r.technician_id);
        if(q && !name.toLowerCase().includes(q)) return;
        const sub = `Last ping: ${new Date(r.recorded_at).toLocaleString()}`;
        // find next job & ETA
        const next = pickNextJobForTech(r.technician_id, jobs);
        let etaInfo = null;
        if(next){
          const distKm = haversine(Number(r.lat), Number(r.lng), Number(next.address_lat), Number(next.address_lng));
          const etaMin = (distKm / Math.max(5, speed)) * 60; // clamp to avoid div by very small
          let lateBy = 0;
          if(next.scheduled_at){
            const minsUntil = Math.round((new Date(next.scheduled_at) - new Date())/60000);
            lateBy = minsUntil>0 ? Math.max(0, Math.round(etaMin - minsUntil)) : 0;
          }
          etaInfo = { job: next, distKm, etaMin, lateBy };
        }
        markerTech(r.lat, r.lng, name, sub, t, etaInfo).addTo(layerTech);
      });
    }

    function renderJobMarkers(rows){
      layerJobs.clearLayers(); jobMarkerById.clear();
      if(!$('#showJobs').checked) return;
      const q = $('#q').value.trim().toLowerCase();
      const techFilter = $('#tech').value;
      rows.forEach(r=>{
        const label = r.so_id || r.id;
        const sub = r.address || '';
        if(techFilter && String(r.technician_id)!==String(techFilter)) return;
        if(q && !(String(label).toLowerCase().includes(q) || (sub||'').toLowerCase().includes(q))) return;
        const m = markerJob(r.address_lat, r.address_lng, label, sub, r).addTo(layerJobs);
        jobMarkerById.set(String(r.id), m);
      });
    }

    // ---------------------- Trails & ETA line --------------------------------
    async function showTrailForTech(techId){
      if(!$('#showTrails').checked) { alert('Enable "Show trail on tech click" first'); return; }
      if(!techId) return;
      const hours = Number($('#trailHours').value||6);
      const w = `(technician_id,eq,${techId})~and(recorded_at,ge,${isoHoursAgo(hours)})`;
      const url = `${NC_BASE}/tables/${TBL_TLOC}/records?limit=5000&orderBy=recorded_at&order=asc&where=${encodeURIComponent(w)}`;
      const rows = await fetch(url,{headers:H()}).then(r=>r.json());
      layerTrail.clearLayers();
      const pts = rows.filter(r=> r.lat!=null && r.lng!=null).map(r=> [r.lat, r.lng]);
      if(pts.length<2){ alert('Not enough points for a trail'); return; }
      const line = L.polyline(pts, { color:'#9b59b6', weight:3, opacity:0.9 }).addTo(layerTrail);
      L.circleMarker(pts[0], { radius:5, color:'#9b59b6', fillColor:'#9b59b6', fillOpacity:0.8 }).addTo(layerTrail);
      L.circleMarker(pts[pts.length-1], { radius:6, color:'#2ecc71', fillColor:'#2ecc71', fillOpacity:0.9 }).addTo(layerTrail);
      map.fitBounds(line.getBounds().pad(0.2));
    }

    function drawETAForTech(techId){
      const loc = lastLocByTech.get(String(techId));
      const job = pickNextJobForTech(techId, lastJobs);
      layerETA.clearLayers();
      if(!loc || !job) return;
      const line = L.polyline([[loc.lat, loc.lng],[job.address_lat, job.address_lng]], { color:'#2ecc71', weight:2, opacity:0.9, dashArray:'6,6' }).addTo(layerETA);
      map.fitBounds(line.getBounds().pad(0.2));
      const jm = jobMarkerById.get(String(job.id)); if(jm) jm.openPopup();
    }
    window.__showTrail = showTrailForTech; // popup button
    window.__drawETA  = drawETAForTech;    // popup button

    // ---------------------- Refresh cycle ------------------------------------
    let timer = null;
    function setAutoRefresh(){
      if(timer) { clearInterval(timer); timer=null; }
      const sec = Number($('#refreshEvery').value||0); if(sec>0){ timer = setInterval(refresh, sec*1000); }
    }

    async function refresh(){
      const [locs, jobs] = await Promise.all([fetchLatestLocations(), fetchOpenJobs()]);
      lastLocs = locs; lastJobs = jobs; lastLocByTech = new Map(locs.map(l=>[String(l.technician_id), l]));
      renderTechMarkers(locs, jobs); renderJobMarkers(jobs); // do not clear trail layer
    }

    // ---------------------- Settings & bindings -------------------------------
    $('#btnSettings').addEventListener('click', ()=>{
      const base = prompt('NocoDB Base API URL', localStorage.getItem('NC_BASE') || NC_BASE);
      if(base!==null) localStorage.setItem('NC_BASE', base.trim());
      const pat = prompt('Personal Access Token (PAT)', localStorage.getItem('NC_PAT') || NC_PAT);
      if(pat!==null) localStorage.setItem('NC_PAT', pat.trim());
      location.reload();
    });

    $('#btnRefresh').addEventListener('click', refresh);
    $('#btnFit').addEventListener('click', fitToData);
    $('#refreshEvery').addEventListener('change', setAutoRefresh);
    $('#avgSpeed').addEventListener('change', ()=> renderTechMarkers(lastLocs, lastJobs));
    $('#q').addEventListener('input', ()=> renderTechMarkers(lastLocs, lastJobs));
    $('#status').addEventListener('change', refresh);
    $('#tech').addEventListener('change', refresh);
    $('#showJobs').addEventListener('change', refresh);

    // ---------------------- Init ---------------------------------------------
    (async function init(){
      if(!NC_PAT) alert('Missing NocoDB PAT. Click ‚öôÔ∏è Settings to set NC_BASE and NC_PAT.');
      initMap();
      await loadTechs();
      await refresh();
      setAutoRefresh();
    })();
  </script>
</body>
</html>

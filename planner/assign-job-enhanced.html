<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Naveo FSM — Create / Assign Service Order</title>
  <!-- Global stylesheet (adjust path if file is in a subfolder) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/naveo.css">
  <style>
    .toolbar { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .grow { flex:1 1 auto; }
    .veh-row { display:grid; grid-template-columns: 1fr 110px 48px; gap:10px; }
    .veh-row + .veh-row { margin-top: 8px; }
    .chip { display:inline-flex; align-items:center; gap:8px; padding:4px 10px; border:1px solid var(--border); border-radius:999px; }
    .mini { font-size: var(--text-sm); color: var(--text-muted); }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Naveo FSM</div>
    <span class="muted">Create / Assign Service Order</span>
    <div class="grow"></div>
    <button class="btn" id="btnSettings" title="NocoDB settings">⚙️ Settings</button>
  </div>

  <aside class="sidebar">
    <div class="brand">Naveo</div>
    <a href="dashboard.html">Dashboard</a>
    <a class="active" href="assign-job-enhanced.html">Assign Job</a>
    <a href="planner-jobs.html">Service Orders</a>
    <a href="planner-inventory.html">Inventory</a>
    <a href="reports.html">Reports</a>
  </aside>

  <main class="main">
    <div class="card">
      <div class="card-header">
        <h2>Service Order details</h2>
        <div class="toolbar">
          <button class="btn" id="btnNewId">Generate SO ID</button>
          <span class="chip">Current SO ID: <strong id="soPreview">—</strong></span>
        </div>
      </div>
      <div class="card-body">
        <form class="form" id="soForm">
          <div class="form-row">
            <div class="col-4">
              <label class="label">SO ID</label>
              <input id="so_id" class="input" placeholder="auto e.g. SO-20250814-123456" />
              <div class="help">Leave empty to auto-generate.</div>
            </div>
            <div class="col-4">
              <label class="label">Technician</label>
              <select id="technician_id" class="select" required></select>
            </div>
            <div class="col-4">
              <label class="label">Intervention Type</label>
              <select id="intervention_type_id" class="select" required></select>
              <div class="help"><span id="ckCount">0</span> checklist items will be added.</div>
            </div>

            <div class="col-6">
              <label class="label">Scheduled at</label>
              <input id="scheduled_at" type="datetime-local" class="input" required />
            </div>
            <div class="col-3">
              <label class="label">Priority</label>
              <select id="priority" class="select">
                <option>normal</option><option>high</option><option>urgent</option><option>low</option>
              </select>
            </div>
            <div class="col-3">
              <label class="label">Status</label>
              <select id="status" class="select">
                <option>assigned</option><option>in_progress</option><option>completed</option><option>cancelled</option>
              </select>
            </div>

            <div class="col-12"><label class="label">Address</label>
              <textarea id="address" class="textarea" required></textarea></div>
            <div class="col-3"><label class="label">Lat</label><input id="address_lat" class="input" type="number" step="0.000001" placeholder="optional"></div>
            <div class="col-3"><label class="label">Lng</label><input id="address_lng" class="input" type="number" step="0.000001" placeholder="optional"></div>
            <div class="col-3"><label class="label">Contact person</label><input id="contact_person" class="input" /></div>
            <div class="col-3"><label class="label">Contact phone</label><input id="contact_phone" class="input" /></div>

            <div class="col-12"><label class="label">Notes</label><textarea id="notes" class="textarea" placeholder="Optional notes for the technician"></textarea></div>

            <div class="col-4"><label class="control-inline"><input type="checkbox" id="return_visit_required" /><span>Return visit required</span></label></div>
            <div class="col-4"><label class="label">Follow-up of SO (optional id)</label><input id="follow_up_of_so_id" class="input" /></div>
          </div>
        </form>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-header">
        <h3>Vehicles</h3>
        <div class="toolbar">
          <label class="control-inline"><input type="checkbox" id="ckPerVehicle" /><span>Duplicate checklist per vehicle</span></label>
          <button class="btn" id="btnAddVeh">＋ Add vehicle</button>
        </div>
      </div>
      <div class="card-body">
        <div id="vehList"></div>
        <div class="help mt-2">Add one row per vehicle (e.g., registration/plate). You can leave this empty if the job is not vehicle-specific.</div>
      </div>
    </div>

    <div class="flex justify-between items-center mt-4">
      <div class="muted">After creating, you can assign hardware and SIMs on the next screen.</div>
      <div>
        <button class="btn" id="btnPreviewChecklist">Preview checklist</button>
        <button class="btn btn-primary" id="btnCreate">Create Service Order</button>
      </div>
    </div>

    <div id="result" class="mt-4"></div>
  </main>

  <!-- Checklist preview modal -->
  <div class="modal-backdrop" id="ckModal">
    <div class="modal" role="dialog" aria-modal="true">
      <header><h3>Checklist Preview</h3></header>
      <div class="content" id="ckPreview">Loading…</div>
      <footer><button class="btn" data-close>Close</button></footer>
    </div>
  </div>

  <script>
    // ---------------------- Config -------------------------------------------
    const NC_BASE = localStorage.getItem('NC_BASE') || 'https://app.nocodb.com/api/v2';
    const NC_PAT  = localStorage.getItem('NC_PAT') || '';
    const TBL_SO   = 'm2dmcyfy30klv76';   // service_orders
    const TBL_SOV  = 'mvn2do01qdif4yt';   // service_order_vehicles
    const TBL_TECH = 'mzw1focsec0tekg';   // technicians
    const TBL_INT  = 'mb4yox88hd24r0h';   // intervention_types
    const TBL_CK   = 'ma917pno6w5e1ed';   // checklists (masters)
    const TBL_SOC  = 'mibtqjiulezywtx';   // service_order_checklist (lines)

    const H = () => ({ 'Content-Type': 'application/json', 'xc-token': NC_PAT });
    const $ = (s, p=document) => p.querySelector(s);
    const $$ = (s, p=document) => Array.from(p.querySelectorAll(s));

    // ---------------------- Helpers ------------------------------------------
    function newSoId(){
      const d = new Date();
      const pad = (n) => String(n).padStart(2, '0');
      const id = `SO-${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
      return id;
    }

    function vehRowTpl(value=''){
      const row = document.createElement('div');
      row.className = 'veh-row';
      row.innerHTML = `
        <input class="input" placeholder="Vehicle number / plate" value="${value}">
        <select class="select"><option>—</option></select>
        <button class="btn btn-danger" title="Remove">✖</button>`;
      return row;
    }

    // ---------------------- Load data ----------------------------------------
    async function loadTechs(){
      const url = `${NC_BASE}/tables/${TBL_TECH}/records?limit=1000&where=(status,eq,active)&orderBy=full_name&order=asc`;
      const rows = await fetch(url,{headers:H()}).then(r=>r.json());
      $('#technician_id').innerHTML = rows.map(r=>`<option value="${r.id}">${r.full_name||r.email_address||('Tech #'+r.id)}</option>`).join('');
    }

    async function loadInterventions(){
      const url = `${NC_BASE}/tables/${TBL_INT}/records?limit=1000&where=(status,eq,active)&orderBy=intervention_name&order=asc`;
      const rows = await fetch(url,{headers:H()}).then(r=>r.json());
      $('#intervention_type_id').innerHTML = rows.map(r=>`<option value="${r.id}">${r.intervention_name}</option>`).join('');
      // Count checklist items for the first one
      updateChecklistCount();
    }

    async function fetchChecklist(interventionId){
      const url = `${NC_BASE}/tables/${TBL_CK}/records?limit=1000&orderBy=sort_order&order=asc&where=(intervention_type_id,eq,${interventionId})`;
      return fetch(url,{headers:H()}).then(r=>r.json());
    }

    async function updateChecklistCount(){
      const id = $('#intervention_type_id').value; if(!id){ $('#ckCount').textContent = '0'; return; }
      const rows = await fetchChecklist(id); $('#ckCount').textContent = rows.length;
    }

    // ---------------------- Vehicles UI --------------------------------------
    function addVeh(value=''){
      const row = vehRowTpl(value);
      row.querySelector('button').addEventListener('click', ()=>{ row.remove(); });
      $('#vehList').appendChild(row);
    }

    function getVehValues(){
      const values = [];
      $$('#vehList .veh-row').forEach(r=>{
        const v = r.querySelector('input').value.trim();
        if(v) values.push(v);
      });
      return values;
    }

    // ---------------------- Create flow --------------------------------------
    async function createSO(){
      // 1) Build body
      const so_id = $('#so_id').value.trim() || newSoId();
      const bodyFull = {
        so_id,
        technician_id: $('#technician_id').value,
        intervention_type_id: $('#intervention_type_id').value,
        scheduled_at: $('#scheduled_at').value,
        address: $('#address').value.trim(),
        address_lat: $('#address_lat').value ? Number($('#address_lat').value) : undefined,
        address_lng: $('#address_lng').value ? Number($('#address_lng').value) : undefined,
        contact_person: $('#contact_person').value.trim() || undefined,
        contact_phone: $('#contact_phone').value.trim() || undefined,
        priority: $('#priority').value,
        status: $('#status').value,
        notes: $('#notes').value.trim() || undefined,
        return_visit_required: $('#return_visit_required').checked || undefined,
        follow_up_of_so_id: $('#follow_up_of_so_id').value || undefined,
      };

      // 2) Try create with full body; if 4xx retry with minimal
      const minimal = {
        so_id: bodyFull.so_id,
        technician_id: bodyFull.technician_id,
        intervention_type_id: bodyFull.intervention_type_id,
        scheduled_at: bodyFull.scheduled_at,
        address: bodyFull.address,
        priority: bodyFull.priority,
        status: bodyFull.status,
      };

      let so = null;
      for (const payload of [bodyFull, minimal]){
        const r = await fetch(`${NC_BASE}/tables/${TBL_SO}/records`,{ method:'POST', headers:H(), body: JSON.stringify(payload) });
        if(r.ok){ so = await r.json(); break; }
      }
      if(!so){ alert('Failed to create Service Order. Check required columns exist.'); return; }

      // 3) Create vehicle rows
      const vehs = getVehValues();
      const createdVehs = [];
      for(const vn of vehs){
        const r = await fetch(`${NC_BASE}/tables/${TBL_SOV}/records`,{ method:'POST', headers:H(), body: JSON.stringify({ service_order_id: so.id, vehicle_no: vn }) });
        if(r.ok){ createdVehs.push(await r.json()); }
      }

      // 4) Create checklist instances
      const ck = await fetchChecklist($('#intervention_type_id').value);
      const perVehicle = $('#ckPerVehicle').checked && createdVehs.length > 0;
      if(ck.length){
        if(perVehicle){
          for(const v of createdVehs){
            for(const item of ck){
              await fetch(`${NC_BASE}/tables/${TBL_SOC}/records`,{ method:'POST', headers:H(), body: JSON.stringify({ service_order_id: so.id, service_order_vehicle_id: v.id, checklist_id: item.id, status: 'pending' }) });
            }
          }
        } else {
          for(const item of ck){
            await fetch(`${NC_BASE}/tables/${TBL_SOC}/records`,{ method:'POST', headers:H(), body: JSON.stringify({ service_order_id: so.id, checklist_id: item.id, status: 'pending' }) });
          }
        }
      }

      // 5) Show result & next steps
      const linkAssign = `assign-inventory-selector.html?so=${encodeURIComponent(so.id)}`;
      $('#result').innerHTML = `
        <div class="card">
          <div class="card-header"><h3>Created <span class="badge status-assigned">${so.status||'assigned'}</span></h3></div>
          <div class="card-body">
            <div class="grid grid-3 gap-4">
              <div><div class="muted mini">SO_ID</div><div class="fw-600">${so.so_id || so.id}</div></div>
              <div><div class="muted mini">Technician</div><div>${$('#technician_id').selectedOptions[0].textContent}</div></div>
              <div><div class="muted mini">Scheduled</div><div>${$('#scheduled_at').value}</div></div>
            </div>
            <hr>
            <div class="flex gap-4">
              <a class="btn btn-primary" href="${linkAssign}">Assign Inventory</a>
              <a class="btn" href="planner-jobs.html">Go to Service Orders</a>
            </div>
          </div>
        </div>`;
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    // ---------------------- Checklist preview --------------------------------
    async function openPreview(){
      const ck = await fetchChecklist($('#intervention_type_id').value);
      const list = ck.map(x=>`<li>${x.checklist_item} ${x.is_required? '<span class=\"badge success\">required</span>':''}</li>`).join('');
      $('#ckPreview').innerHTML = `<ul style="display:grid; gap:8px;">${list || '<li class=\'muted\'>No checklist items for this intervention.</li>'}</ul>`;
      $('#ckModal').classList.add('show');
    }

    // ---------------------- Settings & modal ---------------------------------
    $('#btnSettings').addEventListener('click', ()=>{
      const base = prompt('NocoDB Base API URL', localStorage.getItem('NC_BASE') || NC_BASE);
      if(base!==null) localStorage.setItem('NC_BASE', base.trim());
      const pat = prompt('Personal Access Token (PAT)', localStorage.getItem('NC_PAT') || NC_PAT);
      if(pat!==null) localStorage.setItem('NC_PAT', pat.trim());
      location.reload();
    });

    $('#btnNewId').addEventListener('click', ()=>{ const id=newSoId(); $('#so_id').value=id; $('#soPreview').textContent=id; });
    $('#intervention_type_id').addEventListener('change', updateChecklistCount);
    $('#btnPreviewChecklist').addEventListener('click', (e)=>{ e.preventDefault(); openPreview(); });
    $('#ckModal').addEventListener('click', (e)=>{ if(e.target.matches('.modal-backdrop,[data-close]')) $('#ckModal').classList.remove('show'); });

    $('#btnAddVeh').addEventListener('click', ()=> addVeh(''));
    $('#btnCreate').addEventListener('click', (e)=>{ e.preventDefault(); createSO(); });

    // ---------------------- Init ---------------------------------------------
    (async function init(){
      if(!NC_PAT) alert('Missing NocoDB PAT. Click ⚙️ Settings to set NC_BASE and NC_PAT.');
      $('#soPreview').textContent = '—';
      addVeh(''); // start with 1 row
      await loadTechs();
      await loadInterventions();
      // default schedule now + 2h
      const d=new Date(Date.now()+2*60*60*1000); const p=(n)=>String(n).padStart(2,'0');
      $('#scheduled_at').value = `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Assign Service Order – Naveo FSM Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary: #007bff;
      --primary-dark: #0056b3;
      --success: #28a745;
      --danger: #dc3545;
      --bg: #f5f7fa;
      --card-bg: #fff;
      --radius: 8px;
      --spacing: 1rem;
      --text: #333;
      --border: #ddd;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: var(--spacing);
    }
    h2 {
      text-align: center;
      color: var(--primary);
      margin-bottom: var(--spacing);
      font-size: 1.5rem;
    }
    form {
      max-width: 800px;
      margin: 0 auto;
      background: var(--card-bg);
      padding: var(--spacing);
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: var(--spacing);
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: var(--primary-dark);
    }
    input, select, textarea {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 1rem;
    }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }
    #entries {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .row {
      display: flex;
      gap: 0.5rem;
    }
    .row > input, .row > select { flex: 1; }
    .row button {
      background: var(--danger);
      color: #fff;
      border: none;
      border-radius: var(--radius);
      padding: 0 0.75rem;
      cursor: pointer;
      transition: background 0.3s;
    }
    .row button:hover { background: #c82333; }
    .btn {
      display: inline-block;
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-success { background: var(--success); color: #fff; }
    .btn-success:hover { background: #218838; }
    .btn + .btn { margin-left: 0.5rem; }
    .table-container {
      overflow-x: auto;
      margin-top: var(--spacing);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
      border-radius: var(--radius);
      overflow: hidden;
    }
    th, td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 0.95rem;
    }
    th { background: var(--primary); color: #fff; }
    tr:nth-child(even) td { background: #f9f9f9; }
    #modal {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: none;
      justify-content: center; align-items: center;
    }
    #modalContent {
      background: var(--card-bg); padding: var(--spacing);
      border-radius: var(--radius); width: 90%; max-width: 500px;
      max-height: 80%; overflow-y: auto;
    }
    #modalContent h3 {
      margin-top: 0; color: var(--primary);
    }
    @media (max-width: 600px) {
      .row { flex-direction: column; }
      .btn + .btn { margin-left: 0; margin-top: 0.5rem; }
      form { padding: 0.5rem; }
    }
  </style>
</head>
<body>
  <h2>Assign Service Order</h2>
  <form id="soForm">
    <div class="form-group">
      <label for="technician">Technician</label>
      <select id="technician" required>
        <option value="">-- Loading… --</option>
      </select>
    </div>

    <div class="form-group">
      <label>Vehicle & Job Type</label>
      <div id="entries"></div>
      <button type="button" class="btn btn-primary" onclick="addRow()">+ Add Vehicle</button>
    </div>

    <div class="row">
      <div class="form-group">
        <label for="soDate">Date</label>
        <input type="date" id="soDate" required />
      </div>
      <div class="form-group">
        <label for="soTime">Time</label>
        <input type="time" id="soTime" required />
      </div>
    </div>

    <div class="form-group">
      <label for="address">Address</label>
      <textarea id="address" rows="2" required></textarea>
    </div>
    <div class="row">
      <div class="form-group">
        <label for="contactPerson">Contact Person</label>
        <input type="text" id="contactPerson" required />
      </div>
      <div class="form-group">
        <label for="contactPhone">Contact Phone</label>
        <input type="tel" id="contactPhone" required />
      </div>
    </div>

    <button type="button" class="btn btn-primary" onclick="showSummary()">Preview Summary</button>
  </form>

  <div class="table-container">
    <table id="summaryTable">
      <thead>
        <tr><th>Vehicle No</th><th>Job Type</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="modal">
    <div id="modalContent">
      <h3>Service Order Summary</h3>
      <div id="modalBody"></div>
      <div style="text-align:right; margin-top:1rem;">
        <button class="btn btn-primary" onclick="closeModal()">Edit</button>
        <button class="btn btn-success" onclick="sendSO()">Send</button>
      </div>
    </div>
  </div>

  <script>
    const sheetDB = "https://sheetdb-proxy.navegeo33.workers.dev/api/v1/xg2dgvssxzvag";
    let jobTypes = [];

    async function loadDropdowns() {
      // Technicians from Technicians sheet, only those active
      const techs = await fetch(`${sheetDB}/Technicians/search?Status=Active`).then(r=>r.json());
      const techSel = document.getElementById("technician");
      techSel.innerHTML = '<option value="">-- Select --</option>';
      techs.forEach(t => {
        techSel.add(new Option(
          `${t.FullName} (${t.Email})`,
          t.TechnicianID
        ));
      });

      // Load job types from JobTypes sheet
      jobTypes = await fetch(`${sheetDB}/JobTypes`).then(r=>r.json());
    }

    function addRow() {
      const container = document.getElementById("entries");
      const row = document.createElement("div"); row.className="row";
      row.innerHTML = `
        <input type="text" name="vehicleNo" placeholder="Vehicle No" required />
        <select name="jobType" required>
          <option value="">-- Job Type --</option>
          ${jobTypes.map(j=>`<option value="${j.JobTypeID}">${j.JobTypeName}</option>`).join('')}
        </select>
        <button type="button" onclick="this.parentNode.remove(); updateSummary()">–</button>`;
      row.querySelectorAll("input,select").forEach(el=>el.addEventListener('change', updateSummary));
      container.append(row);
      updateSummary();
    }

    function updateSummary(){
      const tbody = document.querySelector("#summaryTable tbody"); tbody.innerHTML = '';
      document.querySelectorAll("#entries .row").forEach(r=>{
        const veh = r.querySelector("[name=vehicleNo]").value.trim();
        const jt  = r.querySelector("[name=jobType] option:checked").text;
        if(veh && jt) tbody.insertAdjacentHTML('beforeend', `<tr><td>${veh}</td><td>${jt}</td></tr>`);
      });
    }

    function gatherData(){
      const soId = 'SO' + new Date().toISOString().replace(/[-:.TZ]/g,'');
      return Object.assign({
        SO_ID: soId,
        TechnicianID: document.getElementById('technician').value,
        Date: document.getElementById('soDate').value,
        Time: document.getElementById('soTime').value,
        Address: document.getElementById('address').value.trim(),
        ContactPerson: document.getElementById('contactPerson').value.trim(),
        ContactPhone: document.getElementById('contactPhone').value.trim(),
      }, (() => {
        const v=[], j=[];
        document.querySelectorAll('#entries .row').forEach(r=>{
          const vv=r.querySelector('[name=vehicleNo]').value.trim();
          const jj=r.querySelector('[name=jobType]').value;
          if(vv&&jj){ v.push(vv); j.push(jj); }
        });
        return { Vehicles: v.join(','), JobTypeIDs: j.join(','), ChecklistStatus:'Pending', InventoryAssigned:'', FileURL:'' };
      })());
    }

    function showSummary(){
      const data = gatherData();
      document.getElementById('modalBody').innerHTML = '<pre>'+JSON.stringify(data,null,2)+'</pre>';
      document.getElementById('modal').style.display = 'flex';
    }
    function closeModal(){ document.getElementById('modal').style.display = 'none'; }
    async function sendSO(){
      const payload={ data: gatherData() };
      const res = await fetch(`${sheetDB}/ServiceOrders`,{
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
      });
      if(res.ok){ alert('Service Order created!'); location.reload(); }
      else { alert('Error: '+res.status); }
    }

    loadDropdowns().then(addRow);
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Assign Service Order – Naveo FSM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="../assets/js/noco.js"></script>
  <script src="../assets/js/auth-lite.js"></script>
  <style>
    :root{--primary:#0056b3;--bg:#f5f7fb;--card:#fff;--border:#e5e7eb}
    body{margin:0;background:var(--bg);font-family:Poppins, Arial, sans-serif}
    .wrap{max-width:960px;margin:24px auto;background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.06);padding:20px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    label{font-weight:600;font-size:.9rem}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
    .btn{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.secondary{background:#e9eef7;color:#111}
    .veh-row{display:flex;gap:8px;align-items:center}
    .chip{background:#eef5ff;border-radius:999px;padding:6px 10px;display:inline-flex;gap:8px;align-items:center;margin:4px}
    .row{margin-top:10px}
  </style>
</head>
<body>
  <script>Auth.ensureRole(['planner']);</script>
  <script>document.addEventListener('DOMContentLoaded', ()=> Auth.injectRoleBadge('h2'));</script>

  <div class="wrap">
    <h2 style="margin:0 0 10px">Assign Service Order</h2>

    <div class="grid">
      <div>
        <label>SO ID</label>
        <div style="display:flex;gap:8px">
          <input id="so_id" placeholder="SO-2025-0001" />
          <button class="btn secondary" id="genSO">Generate</button>
        </div>
      </div>
      <div>
        <label>Technician</label>
        <select id="technician_id"></select>
      </div>

      <div>
        <label>Intervention Type</label>
        <select id="intervention_type_id"></select>
      </div>
      <div>
        <label>Priority</label>
        <select id="priority">
          <option value="low">low</option>
          <option value="normal" selected>normal</option>
          <option value="high">high</option>
          <option value="urgent">urgent</option>
        </select>
      </div>

      <div>
        <label>Scheduled At</label>
        <input id="scheduled_at" type="datetime-local"/>
      </div>
      <div></div>

      <div>
        <label>Address</label>
        <input id="address" placeholder="Street, City"/>
      </div>
      <div class="grid">
        <div>
          <label>Latitude</label>
          <input id="address_lat" type="number" step="0.000001" placeholder="-20.160000"/>
        </div>
        <div>
          <label>Longitude</label>
          <input id="address_lng" type="number" step="0.000001" placeholder="57.501000"/>
        </div>
      </div>

      <div style="grid-column:1/-1">
        <label>Notes</label>
        <textarea id="notes" rows="3" placeholder="Optional"></textarea>
      </div>
    </div>

    <div class="row">
      <h3 style="margin:8px 0">Vehicles</h3>
      <div class="veh-row">
        <input id="vehInput" placeholder="e.g. 1234 MR 20"/>
        <button class="btn secondary" id="addVeh">Add Vehicle</button>
      </div>
      <div id="vehList" style="display:flex;flex-wrap:wrap;margin-top:6px;"></div>
    </div>

    <div class="row" style="display:flex;gap:8px;align-items:center">
      <button class="btn" id="saveSO">Assign</button>
      <a href="./planner-jobs.html" class="btn secondary">Back to Jobs</a>
      <div id="msg" style="color:#0056b3"></div>
    </div>
  </div>

  <script>
    const { T } = NC, api = NCAPI;
    const veh = [];
    function setMsg(t){ document.getElementById('msg').textContent = t; }

    function renderVeh(){
      const box = document.getElementById('vehList');
      box.innerHTML = veh.map((v,i)=>`<span class="chip">${v}<button class="btn secondary" style="padding:2px 8px" onclick="removeVeh(${i})">×</button></span>`).join('');
    }
    window.removeVeh = (i)=>{ veh.splice(i,1); renderVeh(); };

    document.getElementById('addVeh').onclick = ()=>{
      const v = document.getElementById('vehInput').value.trim();
      if(!v) return;
      if(veh.includes(v)) return setMsg('Vehicle already added.');
      veh.push(v); document.getElementById('vehInput').value=''; renderVeh();
    };

    document.getElementById('genSO').onclick = ()=>{
      const ts = new Date();
      const id = `SO-${ts.getFullYear()}${String(ts.getMonth()+1).padStart(2,'0')}${String(ts.getDate()).padStart(2,'0')}-${String(ts.getHours()).padStart(2,'0')}${String(ts.getMinutes()).padStart(2,'0')}${String(ts.getSeconds()).padStart(2,'0')}`;
      document.getElementById('so_id').value = id;
    };

    async function loadDropdowns(){
      const [techs, types] = await Promise.all([
        api.list(T.technicians, 'limit=1000&sort=full_name'),
        api.list(T.intervention_types, 'limit=1000&sort=intervention_name')
      ]);
      const techSel = document.getElementById('technician_id');
      const typeSel = document.getElementById('intervention_type_id');
      techSel.innerHTML = techs.list.map(t=> `<option value="${t.id}">${t.full_name || t.email_address || ('Tech #'+t.id)}</option>`).join('');
      typeSel.innerHTML = types.list.map(t=> `<option value="${t.id}">${t.intervention_name}</option>`).join('');
    }

    document.getElementById('saveSO').onclick = async ()=>{
      try{
        setMsg('');
        const so_id = document.getElementById('so_id').value.trim();
        const technician_id = +document.getElementById('technician_id').value;
        const intervention_type_id = +document.getElementById('intervention_type_id').value;
        const scheduled_at = document.getElementById('scheduled_at').value ? new Date(document.getElementById('scheduled_at').value).toISOString() : null;
        const priority = document.getElementById('priority').value;
        const address = document.getElementById('address').value;
        const address_lat_raw = document.getElementById('address_lat').value;
        const address_lng_raw = document.getElementById('address_lng').value;
        const address_lat = address_lat_raw === '' ? null : parseFloat(address_lat_raw);
        const address_lng = address_lng_raw === '' ? null : parseFloat(address_lng_raw);
        const notes = document.getElementById('notes').value;

        if(!so_id) return setMsg('SO ID is required');
        if(!technician_id) return setMsg('Technician is required');
        if(!intervention_type_id) return setMsg('Intervention type is required');
        if(!scheduled_at) return setMsg('Scheduled time is required');
        if(veh.length===0) return setMsg('Add at least one vehicle');

        const so = await api.create(T.service_orders, {
          so_id, technician_id, intervention_type_id, scheduled_at, priority,
          address, address_lat, address_lng, notes, status:'assigned'
        });

        await Promise.all(veh.map(v => api.create(T.service_order_vehicles, {
          service_order_id: so.id, vehicle_no: v
        })));

        setMsg(`✅ Assigned ${so.so_id || so.id} with ${veh.length} vehicle(s).`);
        setTimeout(()=> window.location.href='./planner-jobs.html', 700);
      }catch(e){
        console.error(e); setMsg('Error: '+ e.message);
      }
    };

    (async function init(){ await loadDropdowns(); })();
  </script>
</body>
</html>

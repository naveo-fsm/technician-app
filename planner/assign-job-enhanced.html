<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Naveo FSM — Create / Assign Service Order</title>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Inline, modern light theme CSS -->
  <style>
    /* ======= Design tokens (LIGHT) ======= */
    :root{
      --bg: #f6f7fb;
      --surface: #ffffff;
      --surface-2: #fafbff;
      --surface-muted: #f4f6fb;
      --text: #0f172a;
      --text-muted: #6b7280;
      --primary: #2563eb;
      --accent: #7c3aed;
      --success: #16a34a;
      --warning: #d97706;
      --danger: #dc2626;
      --border: rgba(15,23,42,.12);
      --radius-sm: 8px; --radius-md: 12px; --radius-lg: 16px;
      --shadow-sm: 0 1px 2px rgba(2,6,23,.06);
      --shadow-md: 0 8px 24px rgba(2,6,23,.08);
      --shadow-lg: 0 18px 48px rgba(2,6,23,.10);
      --space-1: 4px; --space-2: 8px; --space-3: 12px; --space-4: 16px; --space-5: 20px; --space-6: 24px;
      --text-sm: .875rem; --text-xs: .78rem;
    }

    /* ======= Base ======= */
    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font: 400 16px/1.5 Poppins, ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    a{ color: var(--primary); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .fw-600{ font-weight:600; }
    .text-sm{ font-size: var(--text-sm); }
    .muted{ color: var(--text-muted); }
    .mt-2{ margin-top:8px; } .mt-3{ margin-top:12px; } .mt-4{ margin-top:16px; }
    .mb-4{ margin-bottom:16px; }
    .flex{ display:flex; } .justify-between{ justify-content:space-between; } .items-center{ align-items:center; }
    .gap-4{ gap: 16px; }
    .grow{ flex:1 1 auto; }
    .grid{ display:grid; }
    .grid-3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    hr{ border:0; height:1px; background:var(--border); margin:16px 0; }

    /* ======= App layout ======= */
    .topbar{
      position:sticky; top:0; z-index:50; display:flex; align-items:center; gap:12px;
      padding: 10px 16px; background: rgba(255,255,255,.9); border-bottom:1px solid var(--border);
      backdrop-filter: blur(8px);
    }
    .topbar .title{ font-weight:700; letter-spacing:.3px; }

    .sidebar{
      position:fixed; inset:56px auto 0 0; width:240px; padding:16px;
      background:var(--surface); border-right:1px solid var(--border); overflow:auto;
      display:flex; flex-direction:column;
    }
    .sidebar a{ display:block; padding:10px 12px; border-radius:10px; color:inherit; text-decoration:none; }
    .sidebar a:hover{ background:rgba(37,99,235,.06); }
    .sidebar a.active{ background:rgba(37,99,235,.12); border:1px solid rgba(37,99,235,.35); }
    .sidebar .footer{ margin-top:auto; padding-top:8px; }
    .sidebar .logout{ width:100%; display:flex; justify-content:center; }

    .main{ margin-left:240px; padding: 18px; }

    /* ======= Cards / containers ======= */
    .card{ background:var(--surface); border:1px solid var(--border); border-radius: 16px; box-shadow:0 1px 2px rgba(2,6,23,.06); }
    .card-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 16px 20px; border-bottom:1px solid var(--border); }
    .card-body{ padding: 20px; }

    /* Buttons */
    .btn{
      --bg:transparent; --bd:var(--border); --fg:var(--text);
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px;
      border:1px solid var(--bd); background:var(--bg); color:var(--fg);
      border-radius:10px; cursor:pointer; transition: .15s ease;
    }
    .btn:hover{ background: rgba(2,6,23,.03); }
    .btn-sm{ padding:6px 10px; font-size: .875rem; border-radius:8px; }
    .btn-primary{ --bg: linear-gradient(135deg, var(--primary), var(--accent)); --bd: rgba(2,6,23,.08); --fg:#fff; color:#fff; }
    .btn-danger{ --bd: rgba(220,38,38,.4); color:#991b1b; }

    /* Inputs */
    .input,.select,.textarea{
      width:100%; padding:10px 12px; background:#fff; color:var(--text);
      border:1px solid var(--border); border-radius:10px; outline:none; transition:.12s ease;
    }
    .textarea{ min-height:96px; resize:vertical; }
    .input:focus,.select:focus,.textarea:focus{ border-color: rgba(37,99,235,.6); box-shadow: 0 0 0 3px rgba(37,99,235,.18); }
    .label{ display:block; margin-bottom:6px; font-weight:500; color:var(--text-muted); }
    .help{ margin-top:6px; color:var(--text-muted); font-size: .875rem; }

    .form-row{ display:grid; grid-template-columns: repeat(12, 1fr); gap: 12px; }
    .col-12{ grid-column: span 12; } .col-9{ grid-column: span 9; }
    .col-8{ grid-column: span 8; } .col-6{ grid-column: span 6; } .col-4{ grid-column: span 4; } .col-3{ grid-column: span 3; } .col-2{ grid-column: span 2; }
    .control-inline{ display:inline-flex; align-items:center; gap:8px; cursor:pointer; }

    /* Badges */
    .badge{ display:inline-block; padding:4px 8px; border-radius:999px; background:#fff; border:1px solid var(--border); font-size:.875rem; }
    .badge.success{ background:rgba(22,163,74,.10); border-color:rgba(22,163,74,.35); color:#166534; }
    .badge[class*="status-"]{ background:rgba(37,99,235,.10); border-color:rgba(37,99,235,.35); color:#1e40af; }
    .mini{ font-size:.875rem; color: var(--text-muted); }

    /* Modals */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(15,23,42,.4); display:none; align-items:center; justify-content:center; z-index:60; }
    .modal-backdrop.show{ display:flex; }
    .modal{ width:min(720px, 96vw); background:var(--surface); border:1px solid var(--border); border-radius:16px; overflow:hidden; box-shadow:0 18px 48px rgba(2,6,23,.10); }
    .modal header{ padding: 16px 20px; border-bottom:1px solid var(--border); }
    .modal .content{ padding: 20px; max-height:65vh; overflow:auto; }
    .modal footer{ padding: 16px 20px; border-top:1px solid var(--border); display:flex; gap:10px; justify-content:flex-end; }

    @media (max-width: 980px){ .sidebar{ width:210px; } .main{ margin-left:210px; } }
    @media (max-width: 760px){
      .sidebar{ position:static; width:auto; display:flex; gap:8px; border-right:0; border-bottom:1px solid var(--border);}
      .main{ margin-left:0; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Naveo FSM</div>
    <span class="muted">Create / Assign Service Order</span>
    <div class="grow"></div>
    <button class="btn" id="btnSettings" title="NocoDB settings">⚙️ Settings</button>
  </div>

  <aside class="sidebar">
    <a href="dashboard.html">Dashboard</a>
    <a href="planner-jobs.html">Service Orders</a>
    <a class="active" href="assign-job-enhanced.html">Assign Job</a>
    <a href="planner-inventory.html">Inventory</a>
    <a href="reports.html">Reports</a>
    <a href="realtime-map.html">Live Map</a>
    <a href="admin-intervention-master.html">Admin · Intervention Types</a>
    <a href="admin-tech-master.html">Admin · Technicians</a>
    <div class="footer"><button class="btn logout" id="btnLogout">Log out</button></div>
  </aside>

  <main class="main">
    <div class="card">
      <div class="card-header">
        <h2>Service Order details</h2>
        <div class="toolbar">
          <button class="btn" id="btnNewId">Generate SO ID</button>
          <span class="chip">Current SO ID: <strong id="soPreview">—</strong></span>
        </div>
      </div>
      <div class="card-body">
        <form class="form" id="soForm">
          <div class="form-row">
            <div class="col-4">
              <label class="label">SO ID</label>
              <input id="so_id" class="input" placeholder="auto e.g. SO-20250814-123456" />
              <div class="help">Leave empty to auto-generate.</div>
            </div>

            <div class="col-4">
              <label class="label">Technician</label>
              <div class="flex" style="gap:10px;">
                <input id="technician_name" class="input" placeholder="Type to search technician…" list="techList" autocomplete="off" />
                <datalist id="techList"></datalist>
                <button class="btn" id="btnQuickCreateTech" type="button" title="Create technician">＋</button>
              </div>
              <input type="hidden" id="technician_id" />
              <div class="help">Pick from the suggestions to lock in the technician.</div>
            </div>

            <div class="col-4">
              <label class="label">Scheduled at</label>
              <input id="scheduled_at" type="datetime-local" class="input" required />
            </div>

            <!-- CLIENT (picker + hidden id) -->
            <div class="col-6">
              <label class="label">Client</label>
              <div class="flex" style="gap:10px;">
                <input id="client_name" class="input" placeholder="Type to search or pick…" />
                <button class="btn" id="btnPickClient" type="button">Find…</button>
                <button class="btn" id="btnQuickCreateClient" type="button" title="Create new client">＋</button>
              </div>
              <input type="hidden" id="client_id" />
              <div class="help">Selecting a client will auto-fill address & contacts.</div>
            </div>

            <div class="col-3">
              <label class="label">Priority</label>
              <select id="priority" class="select">
                <option>normal</option><option>high</option><option>urgent</option><option>low</option>
              </select>
            </div>
            <div class="col-3">
              <label class="label">Status</label>
              <select id="status" class="select">
                <option>assigned</option><option>in_progress</option><option>completed</option><option>cancelled</option>
              </select>
            </div>

            <div class="col-12"><label class="label">Address</label>
              <textarea id="address" class="textarea" required placeholder="Will auto-fill from client if set"></textarea></div>
            <div class="col-3"><label class="label">Contact person</label><input id="contact_person" class="input" placeholder="Auto-filled from client if set"/></div>
            <div class="col-3"><label class="label">Contact phone</label><input id="contact_phone" class="input" placeholder="Auto-filled from client if set"/></div>

            <div class="col-12"><label class="label">Notes</label><textarea id="notes" class="textarea" placeholder="Optional notes for the technician"></textarea></div>

            <div class="col-4"><label class="control-inline"><input type="checkbox" id="return_visit_required" /><span>Return visit required</span></label></div>
            <div class="col-4"><label class="label">Follow-up of SO (optional id)</label><input id="follow_up_of_so_id" class="input" /></div>
          </div>
        </form>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-header">
        <h3>Vehicles & Interventions</h3>
        <div class="toolbar">
          <button class="btn" id="btnAddVeh">＋ Add vehicle</button>
        </div>
      </div>
      <div class="card-body">
        <div id="vehList"></div>
        <div class="help mt-2">
          Add one row per vehicle (e.g., registration/plate). Select the <b>intervention type</b> for each vehicle.
          Checklist lines will be created per vehicle based on the chosen intervention.
        </div>
      </div>
    </div>

    <div class="flex justify-between items-center mt-4">
      <div class="muted">After creating, you can assign hardware and SIMs on the next screen.</div>
      <div>
        <button class="btn" id="btnPreviewChecklist">Preview checklist</button>
        <button class="btn btn-primary" id="btnCreate">Create Service Order</button>
      </div>
    </div>

    <div id="result" class="mt-4"></div>
  </main>

  <!-- Checklist preview modal -->
  <div class="modal-backdrop" id="ckModal">
    <div class="modal" role="dialog" aria-modal="true">
      <header><h3>Checklist Preview</h3></header>
      <div class="content" id="ckPreview">Loading…</div>
      <footer><button class="btn" data-close>Close</button></footer>
    </div>
  </div>

  <!-- Client picker / create modal -->
  <div class="modal-backdrop" id="clientModal">
    <div class="modal" role="dialog" aria-modal="true">
      <header><h3>Find or Create Client</h3></header>
      <div class="content">
        <div class="form">
          <div class="form-row">
            <div class="col-12">
              <label class="label">Search</label>
              <input id="c_q" class="input" placeholder="Name or phone…" />
              <div class="help">Results (max 20)</div>
            </div>
            <div class="col-12" id="c_results" style="display:grid;gap:10px;"></div>
          </div>
        </div>

        <hr>
        <div class="form">
          <div class="form-row">
            <div class="col-12"><h4 class="fw-600" style="margin:0;">New client</h4></div>
            <div class="col-6"><label class="label">Name</label><input id="c_name" class="input" required></div>
            <div class="col-6"><label class="label">Phone</label><input id="c_phone" class="input"></div>
            <div class="col-12"><label class="label">Address</label><textarea id="c_address" class="textarea"></textarea></div>
            <div class="col-6"><label class="label">Contact person</label><input id="c_person" class="input"></div>
            <div class="col-6"><label class="label">Email (optional)</label><input id="c_email" class="input"></div>
          </div>
        </div>
      </div>
      <footer>
        <button class="btn" data-close>Close</button>
        <button class="btn btn-primary" id="c_create">Create client</button>
      </footer>
    </div>
  </div>

  <!-- Technician create modal -->
  <div class="modal-backdrop" id="techModal">
    <div class="modal" role="dialog" aria-modal="true">
      <header><h3>Create Technician</h3></header>
      <div class="content">
        <div class="form">
          <div class="form-row">
            <div class="col-6"><label class="label">Full name</label><input id="t_full_name" class="input" required></div>
            <div class="col-6"><label class="label">Email</label><input id="t_email" class="input"></div>
            <div class="col-6"><label class="label">Phone</label><input id="t_phone" class="input"></div>
            <div class="col-6"><label class="label">Status</label><select id="t_status" class="select"><option>Active</option><option>Inactive</option></select></div>
          </div>
        </div>
      </div>
      <footer>
        <button class="btn" data-close>Close</button>
        <button class="btn btn-primary" id="t_create">Create technician</button>
      </footer>
    </div>
  </div>

  <script>
    // ---------------------- Config ---------------------
    const NC_BASE = 'https://app.nocodb.com/api/v2';
    const NC_PAT  = '7x7ZxLedCtJSWtiD4dNOu9sB7JlEFB8JiVe0TpRh';

    const TBL_SO   = 'm2dmcyfy30klv76';   // service_orders
    const TBL_SOV  = 'mvn2do01qdif4yt';   // service_order_vehicles
    const TBL_TECH = 'mzw1focsec0tekg';   // technicians
    const TBL_INT  = 'mb4yox88hd24r0h';   // intervention_types
    const TBL_CK   = 'ma917pno6w5e1ed';   // checklists (masters)
    const TBL_SOC  = 'mibtqjiulezywtx';   // service_order_checklist (lines)
    const TBL_CLIENTS = 'm5f6kp73u19gitz';// tbl_clients

    // Headers + tiny helpers
    const H = () => ({ 'Accept': 'application/json', 'Content-Type': 'application/json', 'xc-token': NC_PAT });
    const $  = (s, p=document) => p.querySelector(s);
    const $$ = (s, p=document) => Array.from(p.querySelectorAll(s));
    const asList = (d) => (Array.isArray(d) ? d : (d && Array.isArray(d.list) ? d.list : []));

    // ---------------------- Misc helpers ---------------------
    function newSoId(){
      const d = new Date();
      const pad = (n) => String(n).padStart(2, '0');
      return `SO-${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
    }
    function logout(){ try{ localStorage.removeItem('NC_PAT'); localStorage.removeItem('NC_BASE'); }catch(e){} location.href = 'login.html'; }

    // ---------------------- Lookups ---------------------
    let intList = [];
    let techIndex = [];

    async function loadTechs(){
      const base = `${NC_BASE}/tables/${TBL_TECH}/records`;
      let rows = [];
      try{
        const r = await fetch(`${base}?limit=1000`, { headers: H() });
        if (r.ok) rows = asList(await r.json());
      }catch(err){ console.warn('loadTechs plain list error:', err); }

      if (!rows.length) {
        const tries = [
          `?limit=1000&orderBy=full_name&order=asc`,
          `?limit=1000&orderBy=email_address&order=asc`,
          `?limit=1000&where=${encodeURIComponent('(status,eq,Active)~or(status,eq,active)')}`
        ];
        for (const p of tries) {
          try {
            const r = await fetch(base + p, { headers: H() });
            if (!r.ok) continue;
            const arr = asList(await r.json());
            if (arr.length) { rows = arr; break; }
          } catch (err) {}
        }
      }

      const labelOf = (t) => t.full_name || t.name || t.display_name || t.email_address || t.phone || (`Tech #${t.id}`);
      techIndex = rows.map(t => ({ id: t.id, label: labelOf(t) }));

      // Fill datalist
      $('#techList').innerHTML = techIndex.map(t => `<option value="${t.label}"></option>`).join('');

      // Prefill if exactly one tech
      if (techIndex.length === 1){
        $('#technician_name').value = techIndex[0].label;
        $('#technician_id').value = techIndex[0].id;
      }
    }

    async function loadInterventions(){
      try{
        const r = await fetch(`${NC_BASE}/tables/${TBL_INT}/records?limit=1000&orderBy=intervention_name&order=asc`, {headers:H()});
        intList = asList(r.ok ? await r.json() : []);
      }catch(err){ intList = []; }
      $$('#vehList select[data-int]').forEach(sel => applyInterventionOptions(sel));
    }

    async function fetchChecklist(interventionId){
      const url = `${NC_BASE}/tables/${TBL_CK}/records?limit=1000&orderBy=sort_order&order=asc&where=(intervention_type_id,eq,${interventionId})`;
      const r = await fetch(url,{headers:H()});
      return r.ok ? r.json() : [];
    }

    // ---------------------- Vehicles UI ---------------------
    function applyInterventionOptions(selectEl, selected=''){
      const opts = ['<option value="">Select intervention…</option>']
        .concat(intList.map(it => `<option value="${it.id}" ${String(it.id)===String(selected)?'selected':''}>${it.intervention_name}</option>`));
      selectEl.innerHTML = opts.join('');
    }
    function vehRowTpl(value='', intId=''){
      const row = document.createElement('div');
      row.className = 'veh-row';
      row.style.display = 'grid';
      row.style.gridTemplateColumns = '1fr 1fr 48px';
      row.style.gap = '10px';
      row.innerHTML = `
        <input class="input" placeholder="Vehicle number / plate" value="${value}">
        <select class="select" data-int></select>
        <button class="btn btn-danger" title="Remove">✖</button>`;
      applyInterventionOptions(row.querySelector('select[data-int]'), intId);
      row.querySelector('button').addEventListener('click', ()=> row.remove());
      return row;
    }
    function addVeh(value='', intId=''){ $('#vehList').appendChild(vehRowTpl(value, intId)); }
    function getVehValues(){
      const values = [];
      $$('#vehList .veh-row').forEach(r=>{
        const vehicle_no = r.querySelector('input').value.trim();
        const intervention_type_id = r.querySelector('select[data-int]').value;
        if(vehicle_no || intervention_type_id) values.push({ vehicle_no, intervention_type_id });
      });
      return values;
    }

    // ---------------------- Client search/create ---------------------
    async function searchClientsByName(q=''){
      if(!q) return [];
      const like = encodeURIComponent('%'+q+'%');
      const url = `${NC_BASE}/tables/${TBL_CLIENTS}/records?limit=20&orderBy=name&order=asc&where=(name,like,${like})`;
      try{
        const r = await fetch(url, {headers:H()});
        return asList(r.ok ? await r.json() : []);
      }catch(err){ return []; }
    }
    function renderClientResults(rows){
      const box = $('#c_results');
      if(!rows.length){ box.innerHTML = `<div class="muted">No matches.</div>`; return; }
      box.innerHTML = rows.map(r=>`
        <div class="card" style="padding:12px;border-radius:10px;">
          <div class="fw-600">${r.name||'(no name)'}</div>
          <div class="mini">${r.address||''}</div>
          <div class="mini">${r.contact_person||''} ${r.contact_phone? ' · '+r.contact_phone : ''}</div>
          <div class="mt-2">
            <button class="btn btn-sm" data-select-client="${r.id}">Select</button>
          </div>
        </div>`).join('');
    }
    function selectClient(c){
      $('#client_id').value = c.id;
      $('#client_name').value = c.name || '';
      if(!$('#address').value)        $('#address').value = c.address || '';
      if(!$('#contact_person').value) $('#contact_person').value = c.contact_person || '';
      if(!$('#contact_phone').value)  $('#contact_phone').value = c.contact_phone || '';
      closeClientModal();
    }
    async function openClientModal(seed=''){
      $('#clientModal').classList.add('show');
      const v = (seed || '').trim();
      $('#c_q').value = v;
      renderClientResults(v ? await searchClientsByName(v) : []);
      $('#c_q').focus();
    }
    function closeClientModal(){ $('#clientModal').classList.remove('show'); }
    function openClientCreateModal(){
      openClientModal('');
      $('#c_name').value = ''; $('#c_address').value = ''; $('#c_person').value = '';
      $('#c_phone').value = ''; $('#c_email').value = '';
      setTimeout(()=> $('#c_name').focus(), 0);
    }
    async function createClientInline(){
      const body = {
        name: ($('#c_name').value||'').trim(),
        address: ($('#c_address').value||'').trim() || undefined,
        contact_person: ($('#c_person').value||'').trim() || undefined,
        contact_phone: ($('#c_phone').value||'').trim() || undefined,
        email: ($('#c_email').value||'').trim() || undefined,
        status: 'Active',
        date_created: new Date().toISOString()
      };
      if(!body.name){ alert('Client name is required'); return; }
      const dup = await searchClientsByName(body.name);
      if(dup.find(x => (x.name||'').toLowerCase() === body.name.toLowerCase())){
        if(!confirm('A client with the same name exists. Create anyway?')) return;
      }
      try{
        const r = await fetch(`${NC_BASE}/tables/${TBL_CLIENTS}/records`, { method:'POST', headers:H(), body: JSON.stringify(body) });
        const c = r.ok ? await r.json() : await r.json().catch(()=>({}));
        if(!r.ok) throw new Error(c?.msg || c?.message || `HTTP ${r.status}`);
        selectClient(c);
      }catch(err){ alert('Client create failed: ' + err.message); }
    }

    // ---------------------- Technician create ---------------------
    function openTechCreateModal(){
      $('#techModal').classList.add('show');
      $('#t_full_name').value = ''; $('#t_email').value = ''; $('#t_phone').value = '';
      $('#t_status').value = 'Active';
      setTimeout(()=> $('#t_full_name').focus(), 0);
    }
    function closeTechModal(){ $('#techModal').classList.remove('show'); }
    async function createTechInline(){
      const full_name = ($('#t_full_name')?.value || '').trim();
      const email_address = ($('#t_email')?.value || '').trim() || undefined;
      const phone = ($('#t_phone')?.value || '').trim() || undefined;
      const status = ($('#t_status')?.value || 'Active');
      if(!full_name){ alert('Full name is required'); return; }
      const payload = { full_name, email_address, phone, status };
      try{
        const r = await fetch(`${NC_BASE}/tables/${TBL_TECH}/records`, { method:'POST', headers:H(), body: JSON.stringify(payload) });
        const row = r.ok ? await r.json() : await r.json().catch(()=>({}));
        if(!r.ok) throw new Error(row?.msg || row?.message || `HTTP ${r.status}`);
        await loadTechs();
        const label = (row.full_name || row.name || row.display_name || row.email_address || row.phone || `Tech #${row.id}`);
        $('#technician_name').value = label; $('#technician_id').value = row.id;
        closeTechModal();
      }catch(err){ alert('Create technician failed: ' + err.message); }
    }

    // ---------------------- Create SO ---------------------
    async function createSO(){
      const vehs = getVehValues();
      if(vehs.length===0){ alert('Please add at least one vehicle and select its intervention type.'); return; }
      if(vehs.some(v => !v.vehicle_no || !v.intervention_type_id)){ alert('Each vehicle row must have a Vehicle number and an Intervention type.'); return; }

      // Resolve technician
      const techName = ($('#technician_name')?.value || '').trim();
      let techId = $('#technician_id').value;
      if (!techId && techName){
        const exact = techIndex.find(t => t.label.toLowerCase() === techName.toLowerCase());
        if (exact) techId = exact.id;
      }
      if (!techId){ alert('Please pick a technician from the suggestions.'); return; }

      const so_id = $('#so_id').value.trim() || newSoId();
      const bodyFull = {
        so_id,
        technician_id: techId,
        scheduled_at: $('#scheduled_at').value,
        client_id: $('#client_id').value || undefined,
        client_name: $('#client_name').value || undefined,
        address: $('#address').value.trim(),
        contact_person: $('#contact_person').value.trim() || undefined,
        contact_phone: $('#contact_phone').value.trim() || undefined,
        priority: $('#priority').value,
        status: $('#status').value,
        notes: $('#notes').value.trim() || undefined,
        return_visit_required: $('#return_visit_required').checked || undefined,
        follow_up_of_so_id: $('#follow_up_of_so_id').value || undefined,
      };
      const minimal = {
        so_id: bodyFull.so_id,
        technician_id: bodyFull.technician_id,
        scheduled_at: bodyFull.scheduled_at,
        address: bodyFull.address,
        priority: bodyFull.priority,
        status: bodyFull.status,
      };

      let so = null;
      for (const payload of [bodyFull, minimal]){
        const r = await fetch(`${NC_BASE}/tables/${TBL_SO}/records`,{ method:'POST', headers:H(), body: JSON.stringify(payload) });
        if(r.ok){ so = await r.json(); break; }
      }
      if(!so){ alert('Failed to create Service Order. Check required columns exist.'); return; }

      // Vehicles
      const createdVehs = [];
      for(const v of vehs){
        const payloadFull = { service_order_id: so.id, vehicle_no: v.vehicle_no, intervention_type_id: v.intervention_type_id };
        const payloadMinimal = { service_order_id: so.id, vehicle_no: v.vehicle_no };
        let row = null;
        for(const p of [payloadFull, payloadMinimal]){
          const r = await fetch(`${NC_BASE}/tables/${TBL_SOV}/records`,{ method:'POST', headers:H(), body: JSON.stringify(p) });
          if(r.ok){ row = await r.json(); break; }
        }
        if(row){ createdVehs.push({ ...row, _intervention_type_id: v.intervention_type_id }); }
      }

      // Checklist instances per vehicle
      for(const v of createdVehs){
        const ck = await fetchChecklist(v._intervention_type_id);
        for(const item of ck){
          await fetch(`${NC_BASE}/tables/${TBL_SOC}/records`,{
            method:'POST', headers:H(),
            body: JSON.stringify({ service_order_id: so.id, service_order_vehicle_id: v.id, checklist_id: item.id, status: 'pending' })
          });
        }
      }

      const linkAssign = `assign-inventory-selector.html?so=${encodeURIComponent(so.id)}`;
      $('#result').innerHTML = `
        <div class="card">
          <div class="card-header"><h3>Created <span class="badge status-assigned">${so.status||'assigned'}</span></h3></div>
          <div class="card-body">
            <div class="grid grid-3 gap-4">
              <div><div class="mini muted">SO_ID</div><div class="fw-600">${so.so_id || so.id}</div></div>
              <div><div class="mini muted">Technician</div><div>${techName || '—'}</div></div>
              <div><div class="mini muted">Scheduled</div><div>${$('#scheduled_at').value}</div></div>
            </div>
            <hr>
            <div class="flex gap-4">
              <a class="btn btn-primary" href="${linkAssign}">Assign Inventory</a>
              <a class="btn" href="planner-jobs.html">Go to Service Orders</a>
            </div>
          </div>
        </div>`;
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    // ---------------------- UI wiring ---------------------
    // Client type-to-search
    let clientTypeTimer = null;
    $('#client_name').addEventListener('input', (e)=>{
      const val = e.target.value.trim();
      clearTimeout(clientTypeTimer);
      clientTypeTimer = setTimeout(()=> openClientModal(val), 250);
    });
    $('#client_name').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter') { e.preventDefault(); openClientModal(($('#client_name')?.value||'').trim()); }
    });
    $('#client_name').addEventListener('focus', ()=>{
      const val = ($('#client_name')?.value||'').trim();
      if(val) openClientModal(val);
    });

    // Settings + misc
    $('#btnSettings').addEventListener('click', ()=> alert('Demo config:\\nAPI: '+NC_BASE+'\\nPAT: '+NC_PAT.slice(0,6)+'…'));
    $('#btnLogout').addEventListener('click', logout);
    $('#btnNewId').addEventListener('click', ()=>{ const id=newSoId(); $('#so_id').value=id; $('#soPreview').textContent=id; });

    // Modals
    $('#btnPreviewChecklist').addEventListener('click', (e)=>{ e.preventDefault(); openPreview(); });
    $('#ckModal').addEventListener('click', (e)=>{ if(e.target.matches('.modal-backdrop,[data-close]')) $('#ckModal').classList.remove('show'); });
    $('#clientModal').addEventListener('click', (e)=>{ if(e.target.matches('.modal-backdrop,[data-close]')) closeClientModal(); });
    $('#techModal').addEventListener('click',   (e)=>{ if(e.target.matches('.modal-backdrop,[data-close]')) closeTechModal(); });

    // Buttons
    $('#btnAddVeh').addEventListener('click', ()=> addVeh('', ''));
    $('#btnCreate').addEventListener('click', (e)=>{ e.preventDefault(); createSO(); });
    $('#btnPickClient').addEventListener('click', (e)=>{ e.preventDefault(); openClientModal(($('#client_name')?.value||'').trim()); });
    $('#btnQuickCreateClient').addEventListener('click', (e)=>{ e.preventDefault(); openClientCreateModal(); });
    $('#btnQuickCreateTech').addEventListener('click', (e)=>{ e.preventDefault(); openTechCreateModal(); });

    // Client search results
    $('#c_q').addEventListener('input', async (e)=>{ renderClientResults(await searchClientsByName(e.target.value.trim())); });
    $('#c_results').addEventListener('click', async (e)=>{
      const btn = e.target.closest('[data-select-client]'); if(!btn) return;
      const id = btn.getAttribute('data-select-client');
      const row = await fetch(`${NC_BASE}/tables/${TBL_CLIENTS}/records/${id}`, {headers:H()}).then(r=>r.json());
      selectClient(row);
    });
    $('#c_create').addEventListener('click', (e)=>{ e.preventDefault(); createClientInline(); });

    // Technician typeahead -> set hidden id when exact option chosen
    $('#technician_name').addEventListener('change', ()=>{
      const val = ($('#technician_name')?.value || '').trim().toLowerCase();
      const hit = techIndex.find(t => t.label.toLowerCase() === val);
      $('#technician_id').value = hit ? hit.id : '';
    });
    $('#technician_name').addEventListener('input', ()=>{ if ($('#technician_id').value) $('#technician_id').value = ''; });

    // Create technician
    $('#t_create').addEventListener('click', (e)=>{ e.preventDefault(); createTechInline(); });

    // ---------------------- Init ---------------------
    (async function init(){
      $('#soPreview').textContent = '—';
      addVeh('', ''); // start with 1 row
      await loadTechs();
      await loadInterventions();
      const d=new Date(Date.now()+2*60*60*1000); const p=(n)=>String(n).padStart(2,'0');
      $('#scheduled_at').value = `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}T${p(d.getHours())}:${p(d.getMinutes())}`;
    })();
  </script>
</body>
</html>

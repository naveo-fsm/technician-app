<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Planner • Technician Master</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="../assets/js/noco.js"></script>
  <script src="../assets/js/auth-lite.js"></script>
  <style>
    :root{--primary:#0056b3;--bg:#f5f7fb;--card:#fff;--border:#e5e7eb}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:Poppins,Arial,sans-serif}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:#fff;border-bottom:1px solid var(--border)}
    h1{font-size:18px;margin:0}
    .container{padding:16px;display:grid;gap:16px;grid-template-columns:1fr 1fr}
    .card{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.05);padding:16px}
    table{width:100%;border-collapse:collapse} thead th{padding:8px;border-bottom:1px solid var(--border);text-align:left;color:#374151}
    tbody td{padding:8px;border-bottom:1px solid var(--border)}
    label{font-weight:600;font-size:.9rem} input,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center} .btn{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.secondary{background:#e9eef7;color:#111}
    @media(max-width:1020px){ .container{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <script>Auth.ensureRole(['planner']);</script>

  <header>
    <h1>Technicians</h1>
    <nav class="row">
      <a class="btn secondary" href="./planner.html">Home</a>
      <a class="btn secondary" href="./planner-jobs.html">Jobs</a>
    </nav>
  </header>
  <script>document.addEventListener('DOMContentLoaded', ()=> Auth.injectRoleBadge('header'));</script>

  <main class="container">
    <section class="card">
      <h2 style="margin:0 0 10px;font-size:16px">Add / Edit Technician</h2>
      <div class="row">
        <input id="t_id" type="hidden">
        <div style="flex:1"><label>Full Name</label><input id="t_name" placeholder="Jane Doe"/></div>
        <div style="flex:1"><label>Email</label><input id="t_email" placeholder="tech@example.com"/></div>
      </div>
      <div class="row">
        <div style="flex:1"><label>Phone</label><input id="t_phone" placeholder="+230 ..."/></div>
        <div style="flex:1"><label>Role</label>
          <select id="t_role"><option value="technician" selected>technician</option><option value="lead">lead</option></select>
        </div>
        <div style="flex:1"><label>Status</label>
          <select id="t_status"><option value="active" selected>active</option><option value="inactive">inactive</option></select>
        </div>
      </div>
      <div class="row">
        <div style="flex:1"><label>Shift Minutes</label><input id="t_shift" type="number" value="480"/></div>
        <div style="flex:1"><label>Photo URL</label><input id="t_photo" placeholder="https://..."/></div>
        <div style="flex:1"><label>Preferred Language</label><input id="t_lang" placeholder="en/fr/…"/></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="techCreate()">Create</button>
        <button class="btn secondary" onclick="techSave()">Save</button>
        <button class="btn secondary" onclick="clearTech()">Clear</button>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px;font-size:16px">Directory</h2>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Role</th><th>Status</th><th>Shift</th><th></th></tr></thead>
          <tbody id="techBody"><tr><td colspan="7">Loading…</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const { T } = NC, api = NCAPI;

    async function techList(){
      const res = await api.list(T.technicians, 'limit=1000&sort=full_name');
      document.querySelector('#techBody').innerHTML = res.list.map(t=>`
        <tr>
          <td>${t.full_name||''}</td>
          <td>${t.email_address||''}</td>
          <td>${t.phone||''}</td>
          <td>${t.role||''}</td>
          <td>${t.status||''}</td>
          <td>${t.shift_minutes||''}</td>
          <td><button onclick="techEdit(${t.id})">Edit</button> <button onclick="techDel(${t.id})">Del</button></td>
        </tr>`).join('');
    }

    async function techCreate(){
      const b = readTech();
      if(!b.full_name) return alert('Name required');
      if(!b.email_address) return alert('Email required');
      const existing = await api.list(T.technicians, `filter=(email_address,eq,${encodeURIComponent(b.email_address)})&limit=1`);
      if(existing.list.length) return alert('Email already exists');
      await api.create(T.technicians, b);
      await techList(); clearTech();
    }
    async function techEdit(id){
      const r = await api.read(T.technicians, id);
      fillTech(r);
    }
    async function techSave(){
      const b = readTech();
      if(!b.id) return alert('No record selected');
      await api.patch(T.technicians, b);
      await techList(); clearTech();
    }
    async function techDel(id){
      if(!confirm('Delete technician?')) return;
      await api.del(T.technicians, id);
      await techList();
    }

    function readTech(){
      return {
        id: +v('#t_id') || undefined,
        full_name: v('#t_name').trim(),
        email_address: v('#t_email').trim(),
        phone: v('#t_phone').trim(),
        role: v('#t_role') || 'technician',
        status: v('#t_status') || 'active',
        shift_minutes: +v('#t_shift') || 480,
        photo_url: v('#t_photo').trim(),
        preferred_language: v('#t_lang').trim()
      };
    }
    function fillTech(r){
      s('#t_id', r.id);
      s('#t_name', r.full_name||'');
      s('#t_email', r.email_address||'');
      s('#t_phone', r.phone||'');
      s('#t_role', r.role||'technician');
      s('#t_status', r.status||'active');
      s('#t_shift', r.shift_minutes||480);
      s('#t_photo', r.photo_url||'');
      s('#t_lang', r.preferred_language||'');
    }
    function clearTech(){ ['#t_id','#t_name','#t_email','#t_phone','#t_role','#t_status','#t_shift','#t_photo','#t_lang'].forEach(x=>s(x,'')); s('#t_role','technician'); s('#t_status','active'); s('#t_shift','480'); }

    function v(sel){ const e=document.querySelector(sel); return e? e.value : ''; }
    function s(sel,val){ const e=document.querySelector(sel); if(e) e.value = val; }

    document.addEventListener('DOMContentLoaded', techList);
  </script>
</body>
</html>

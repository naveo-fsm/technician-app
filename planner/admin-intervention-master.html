<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Planner • Intervention & Checklist Master</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="../assets/js/noco.js"></script>
  <script src="../assets/js/auth-lite.js"></script>
  <style>
    :root{--primary:#0056b3;--bg:#f5f7fb;--card:#fff;--border:#e5e7eb;--muted:#6b7280}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:Poppins,Arial,sans-serif}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:#fff;border-bottom:1px solid var(--border)}
    h1{font-size:18px;margin:0}
    .container{padding:16px;display:grid;gap:16px;grid-template-columns:1fr 1fr}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 24px rgba(0,0,0,.05);padding:16px}
    table{width:100%;border-collapse:collapse} thead th{padding:8px;border-bottom:1px solid var(--border);text-align:left;color:#374151}
    tbody td{padding:8px;border-bottom:1px solid var(--border);vertical-align:top}
    label{font-weight:600;font-size:.9rem} input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center} .btn{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.secondary{background:#e9eef7;color:#111}
    @media(max-width:1020px){ .container{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <script>Auth.ensureRole(['planner']);</script>

  <header>
    <h1>Intervention Types & Checklists</h1>
    <nav class="row">
      <a class="btn secondary" href="./planner.html">Home</a>
      <a class="btn secondary" href="./planner-jobs.html">Jobs</a>
    </nav>
  </header>
  <script>document.addEventListener('DOMContentLoaded', ()=> Auth.injectRoleBadge('header'));</script>

  <main class="container">
    <!-- Intervention types -->
    <section class="card">
      <h2 style="margin:0 0 10px;font-size:16px">Intervention Types</h2>
      <div class="row">
        <div style="flex:1">
          <label>Name</label>
          <input id="it_name" placeholder="e.g. DVR Installation"/>
        </div>
        <div style="flex:1">
          <label>SLA (minutes)</label>
          <input id="it_sla" type="number" min="0" value="60"/>
        </div>
        <div style="flex:1">
          <label>Status</label>
          <select id="it_status">
            <option value="active" selected>active</option>
            <option value="inactive">inactive</option>
          </select>
        </div>
        <input id="it_id" type="hidden">
      </div>
      <div style="margin-top:8px">
        <label>Description</label>
        <textarea id="it_desc" rows="3" placeholder="Optional"></textarea>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="itCreate()">Create</button>
        <button class="btn secondary" onclick="itSave()">Save</button>
        <button class="btn secondary" onclick="clearITForm()">Clear</button>
      </div>

      <div style="overflow:auto;margin-top:12px">
        <table>
          <thead><tr><th>Name</th><th>Description</th><th>SLA</th><th>Status</th><th></th></tr></thead>
          <tbody id="itTableBody"><tr><td colspan="5">Loading…</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- Checklist template for selected intervention -->
    <section class="card">
      <h2 style="margin:0 0 10px;font-size:16px" id="chkHeader">Checklist (select an intervention)</h2>
      <div class="row">
        <input id="chk_id" type="hidden">
        <div style="flex:2">
          <label>Item</label>
          <input id="chk_item" placeholder="e.g. Mount camera securely"/>
        </div>
        <div>
          <label>Required</label>
          <div class="row"><input id="chk_req" type="checkbox" style="width:auto"><span class="muted">Yes</span></div>
        </div>
        <div style="flex:1">
          <label>Sort Order</label>
          <input id="chk_sort" type="number" value="0"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="chkCreate()">Add</button>
        <button class="btn secondary" onclick="chkSave()">Save</button>
        <button class="btn secondary" onclick="clearChkForm()">Clear</button>
      </div>

      <div style="overflow:auto;margin-top:12px">
        <table>
          <thead><tr><th>Sort</th><th>Item</th><th>Required</th><th></th></tr></thead>
          <tbody id="chkTableBody"><tr><td colspan="4">—</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const { T } = NC, api = NCAPI;

    async function itList(){
      const res = await api.list(T.intervention_types, 'limit=1000&sort=intervention_name');
      const tbody = document.querySelector('#itTableBody');
      if(!tbody) return;
      tbody.innerHTML = res.list.map(r=>`
        <tr>
          <td>${r.intervention_name||''}</td>
          <td>${r.description||''}</td>
          <td>${r.sla_minutes||''}</td>
          <td>${r.status||''}</td>
          <td>
            <button onclick="itEdit(${r.id})">Edit</button>
            <button onclick="itSelect(${r.id})">Checklists</button>
            <button onclick="itDel(${r.id})">Del</button>
          </td>
        </tr>`).join('');
    }

    async function itCreate(){
      const b = readITForm();
      if(!b.intervention_name) return alert('Name required');
      if(b.sla_minutes<0) return alert('SLA must be ≥ 0');
      await api.create(T.intervention_types, b);
      await itList(); clearITForm();
    }
    async function itEdit(id){
      const r = await api.read(T.intervention_types, id);
      fillITForm(r);
    }
    async function itSave(){
      const b = readITForm();
      if(!b.id) return alert('No record selected');
      await api.patch(T.intervention_types, b);
      await itList(); clearITForm();
    }
    async function itDel(id){
      if(!confirm('Delete intervention type?')) return;
      await api.del(T.intervention_types, id);
      await itList();
    }

    function readITForm(){
      return {
        id: +val('#it_id') || undefined,
        intervention_name: val('#it_name').trim(),
        description: val('#it_desc').trim(),
        sla_minutes: +val('#it_sla') || 0,
        status: val('#it_status') || 'active'
      };
    }
    function fillITForm(r){
      set('#it_id', r.id);
      set('#it_name', r.intervention_name||'');
      set('#it_desc', r.description||'');
      set('#it_sla', r.sla_minutes||0);
      set('#it_status', r.status||'active');
    }
    function clearITForm(){ ['#it_id','#it_name','#it_desc','#it_sla','#it_status'].forEach(s=>set(s,'')); set('#it_status','active'); }

    let currentIT = null;
    async function itSelect(id){
      currentIT = id;
      document.getElementById('chkHeader').textContent = 'Checklist for IT #' + id;
      await chkList();
    }
    async function chkList(){
      if(!currentIT) return;
      const res = await api.list(T.checklists, `filter=(intervention_type_id,eq,${currentIT})&sort=sort_order&limit=1000`);
      const tbody = document.querySelector('#chkTableBody');
      tbody.innerHTML = res.list.map(r=>`
        <tr>
          <td>${r.sort_order||''}</td>
          <td>${r.checklist_item||''}</td>
          <td>${r.is_required ? 'yes':'no'}</td>
          <td>
            <button onclick="chkEdit(${r.id})">Edit</button>
            <button onclick="chkDel(${r.id})">Del</button>
          </td>
        </tr>`).join('');
    }
    function clearChkForm(){ ['#chk_id','#chk_item','#chk_sort'].forEach(x=>set(x,'')); document.querySelector('#chk_req').checked=false; }
    async function chkCreate(){
      if(!currentIT) return alert('Select an intervention type first');
      const b = {
        intervention_type_id: currentIT,
        checklist_item: val('#chk_item').trim(),
        is_required: document.querySelector('#chk_req').checked,
        sort_order: +val('#chk_sort') || 0
      };
      if(!b.checklist_item) return alert('Item text required');
      await api.create(T.checklists, b);
      await chkList(); clearChkForm();
    }
    async function chkEdit(id){
      const r = await api.read(T.checklists, id);
      set('#chk_id', r.id);
      set('#chk_item', r.checklist_item||'');
      document.querySelector('#chk_req').checked = !!r.is_required;
      set('#chk_sort', r.sort_order||0);
    }
    async function chkSave(){
      const b = {
        id: +val('#chk_id'),
        checklist_item: val('#chk_item').trim(),
        is_required: document.querySelector('#chk_req').checked,
        sort_order: +val('#chk_sort') || 0
      };
      if(!b.id) return alert('No checklist row selected');
      await api.patch(T.checklists, b);
      await chkList(); clearChkForm();
    }
    async function chkDel(id){
      if(!confirm('Delete checklist row?')) return;
      await api.del(T.checklists, id);
      await chkList();
    }

    function val(sel){ const e=document.querySelector(sel); return e? e.value : ''; }
    function set(sel,v){ const e=document.querySelector(sel); if(e) e.value=v; }

    document.addEventListener('DOMContentLoaded', itList);
  </script>
</body>
</html>

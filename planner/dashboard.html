<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Naveo FSM — Dashboard</title>
  <!-- Global stylesheet (adjust path if file is in a subfolder) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="technician-app/assets/naveo.css" />

  <!-- Charts & Map (optional) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .grid-2-1 { display:grid; grid-template-columns: 2fr 1fr; gap: var(--space-6); }
    @media (max-width: 1200px){ .grid-2-1 { grid-template-columns: 1fr; } }
    .kpi .kpi-item .kpi-delta { font-size: var(--text-sm); color: var(--text-muted); }
    .list { display:grid; gap:12px; }
    .list-item { display:flex; align-items:center; justify-content:space-between; gap:12px; border:1px solid var(--border); background:var(--surface); border-radius:var(--radius-md); padding:10px 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .mini { font-size: var(--text-sm); color: var(--text-muted); }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Naveo FSM</div>
    <span class="muted">Dashboard</span>
    <div style="flex:1 1 auto"></div>
    <button class="btn" id="btnSettings" title="NocoDB settings">⚙️ Settings</button>
  </div>

  <aside class="sidebar">
    <div class="brand">Naveo</div>
    <a class="active" href="dashboard.html">Dashboard</a>
    <a href="planner-jobs.html">Service Orders</a>
    <a href="assign-job-enhanced.html">Assign Job</a>
    <a href="planner-inventory.html">Inventory</a>
    <a href="reports.html">Reports</a>
    <a href="realtime-map.html">Live Map</a>
    <a href="admin-intervention-master.html">Admin · Intervention Types</a>
    <a href="admin-tech-master.html">Admin · Technicians</a>
  </aside>

  <main class="main">
    <!-- KPIs -->
    <div class="kpi">
      <div class="kpi-item">
        <div class="kpi-label">Open (assigned)</div>
        <div class="kpi-value" id="kpiOpen">0</div>
      </div>
      <div class="kpi-item">
        <div class="kpi-label">In Progress</div>
        <div class="kpi-value" id="kpiInProg">0</div>
      </div>
      <div class="kpi-item">
        <div class="kpi-label">Completed Today</div>
        <div class="kpi-value" id="kpiDone">0</div>
      </div>
      <div class="kpi-item">
        <div class="kpi-label">Overdue</div>
        <div class="kpi-value" id="kpiOverdue">0</div>
      </div>
      <div class="kpi-item">
        <div class="kpi-label">First‑Time Fix (today)</div>
        <div class="kpi-value" id="kpiFTF">0%</div>
        <div class="kpi-delta" id="kpiFTFNote" style="margin-top:4px"></div>
      </div>
    </div>

    <div class="grid-2-1 mt-4">
      <!-- Left: Charts & Recent -->
      <div class="grid" style="gap: var(--space-6)">
        <div class="card chart-card">
          <div class="card-header"><h3>Jobs per Technician (today)</h3><div class="mini">Scheduled for today</div></div>
          <div class="card-body">
            <canvas id="chartJobsPerTech"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><h3>Upcoming Jobs (next 7 days)</h3></div>
          <div class="card-body">
            <div class="table-wrap">
              <table class="table" id="tblUpcoming">
                <thead>
                  <tr>
                    <th>When</th>
                    <th>SO</th>
                    <th>Technician</th>
                    <th>Type</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th class="text-right">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><h3>Recent Activity</h3></div>
          <div class="card-body">
            <div id="recentList" class="list"></div>
          </div>
        </div>
      </div>

      <!-- Right: Map & quick links -->
      <div class="grid" style="gap: var(--space-6)">
        <div class="card">
          <div class="card-header"><h3>Live Technicians</h3><div class="mini">Last known location</div></div>
          <div class="card-body">
            <div id="map" class="map-container"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><h3>Quick Actions</h3></div>
          <div class="card-body">
            <div class="grid grid-2" style="gap:12px">
              <a class="btn btn-primary" href="assign-job-enhanced.html">＋ New Service Order</a>
              <a class="btn" href="planner-jobs.html">View All Jobs</a>
              <a class="btn" href="planner-inventory.html">Manage Inventory</a>
              <a class="btn" href="admin-tech-master.html">Manage Technicians</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ---------------------- Config -------------------------------------------
    const NC_BASE = localStorage.getItem('NC_BASE') || 'https://app.nocodb.com/api/v2';
    const NC_PAT  = localStorage.getItem('NC_PAT') || '';
    const TBL_SO   = 'm2dmcyfy30klv76';   // service_orders
    const TBL_TECH = 'mzw1focsec0tekg';   // technicians
    const TBL_INT  = 'mb4yox88hd24r0h';   // intervention_types
    const TBL_TLOC = 'mdau1eojkb8c56x';   // technician_locations
    const TBL_SOSH = 'mirdk2w4yjcny1b';   // service_order_status_history

    const H = () => ({ 'Content-Type': 'application/json', 'xc-token': NC_PAT });
    const $ = (s, p=document) => p.querySelector(s);

    // ---------------------- Date helpers -------------------------------------
    function startOfTodayISO(){
      const d = new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,19);
    }
    function endOfTodayISO(){
      const d = new Date(); d.setHours(23,59,59,999); return new Date(d - d.getTimezoneOffset()*60000).toISOString().slice(0,19);
    }
    function nowISO(){ return new Date().toISOString().slice(0,19); }
    function inDaysISO(days){ const d=new Date(Date.now()+days*86400000); return d.toISOString().slice(0,19); }

    // ---------------------- KPI counts ---------------------------------------
    async function countSO(where){
      let url = `${NC_BASE}/tables/${TBL_SO}/records/count`;
      if(where) url += `?where=${encodeURIComponent(where)}`;
      const r = await fetch(url,{headers:H()}); if(!r.ok) return 0; const j = await r.json(); return j?.count||0;
    }

    async function loadKPIs(){
      const open = await countSO('(status,eq,assigned)');
      const inprog = await countSO('(status,eq,in_progress)');
      const doneToday = await countSO(`(status,eq,completed)~and(completed_at,ge,${startOfTodayISO()})`);
      const overdue = await countSO(`(scheduled_at,lt,${nowISO()})~and(status,neq,completed)~and(status,neq,cancelled)`);

      $('#kpiOpen').textContent = open;
      $('#kpiInProg').textContent = inprog;
      $('#kpiDone').textContent = doneToday;
      $('#kpiOverdue').textContent = overdue;

      const ftfNum = await countSO(`(status,eq,completed)~and(completed_at,ge,${startOfTodayISO()})~and(return_visit_required,eq,false)`);
      const ftf = doneToday ? Math.round(100 * ftfNum / doneToday) : 0;
      $('#kpiFTF').textContent = ftf + '%';
      $('#kpiFTFNote').textContent = `${ftfNum}/${doneToday} first-time fixes`;
    }

    // ---------------------- Jobs per Technician (today) ----------------------
    async function jobsPerTechChart(){
      // fetch all jobs scheduled for today
      const where = `(scheduled_at,ge,${startOfTodayISO()})~and(scheduled_at,le,${endOfTodayISO()})`;
      let url = `${NC_BASE}/tables/${TBL_SO}/records?limit=10000&where=${encodeURIComponent(where)}`;
      const rows = await fetch(url,{headers:H()}).then(r=>r.json());
      // tally by technician_id
      const counts = new Map();
      rows.forEach(r=>{ const k=r.technicians?.full_name || r.technician_id || 'Unassigned'; counts.set(k, (counts.get(k)||0)+1); });
      const labels = Array.from(counts.keys());
      const data = Array.from(counts.values());

      const ctx = document.getElementById('chartJobsPerTech').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Jobs', data }] },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, precision:0 } } }
      });
    }

    // ---------------------- Upcoming (next 7 days) ---------------------------
    async function loadUpcoming(){
      const where = `(scheduled_at,ge,${nowISO()})~and(scheduled_at,le,${inDaysISO(7)})`;
      let url = `${NC_BASE}/tables/${TBL_SO}/records?limit=25&orderBy=scheduled_at&order=asc&where=${encodeURIComponent(where)}`;
      const rows = await fetch(url,{headers:H()}).then(r=>r.json());
      const tbody = document.querySelector('#tblUpcoming tbody'); tbody.innerHTML='';
      rows.forEach(r=>{
        const pr = (r.priority||'normal').toLowerCase();
        const st = (r.status||'assigned').toLowerCase();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.scheduled_at ? new Date(r.scheduled_at).toLocaleString() : ''}</td>
          <td class="mono">${r.so_id || r.id}</td>
          <td>${r.technicians?.full_name || r.technician_id || ''}</td>
          <td>${r.intervention_types?.intervention_name || r.intervention_type_id || ''}</td>
          <td><span class="badge priority-${pr}">${pr}</span></td>
          <td><span class="badge status-${st}">${st}</span></td>
          <td class="text-right"><a class="btn btn-sm" href="assign-inventory-selector.html?so=${encodeURIComponent(r.id)}">Assign inventory</a></td>`;
        tbody.appendChild(tr);
      });
    }

    // ---------------------- Recent Activity ----------------------------------
    async function loadRecent(){
      let url = `${NC_BASE}/tables/${TBL_SOSH}/records?limit=10&orderBy=changed_at&order=desc`;
      const rows = await fetch(url,{headers:H()}).then(r=>r.json());
      const list = document.getElementById('recentList'); list.innerHTML='';
      // Optionally map SO ids to so_id
      const ids = [...new Set(rows.map(r=>r.service_order_id).filter(Boolean))];
      const soMap = new Map();
      if(ids.length){
        const idList = ids.join(',');
        const soUrl = `${NC_BASE}/tables/${TBL_SO}/records?limit=${ids.length}&where=${encodeURIComponent(`(id,in,${idList})`)}`;
        const sos = await fetch(soUrl,{headers:H()}).then(r=>r.json());
        sos.forEach(s=> soMap.set(s.id, s));
      }
      rows.forEach(r=>{
        const so = soMap.get(r.service_order_id);
        const soLabel = so? (so.so_id || so.id) : r.service_order_id;
        const who = r.users?.full_name || r.user_id || 'system';
        const item = document.createElement('div'); item.className='list-item';
        item.innerHTML = `
          <div>
            <div><span class="badge status-${r.status}">${r.status}</span> <span class="mono">${soLabel}</span></div>
            <div class="mini">by ${who} · ${new Date(r.changed_at).toLocaleString()}</div>
          </div>
          <a class="btn btn-sm" href="planner-jobs.html">Open</a>`;
        list.appendChild(item);
      });
    }

    // ---------------------- Map ----------------------------------------------
    let map, markerLayer;
    function ensureMap(){
      if(map) return map;
      map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
      markerLayer = L.layerGroup().addTo(map);
      map.setView([-20.2, 57.5], 9); // Mauritius-ish default; adjust after data
      return map;
    }

    async function loadTechLocations(){
      ensureMap(); markerLayer.clearLayers();
      // Pull last 500 locations, then keep latest per tech
      const url = `${NC_BASE}/tables/${TBL_TLOC}/records?limit=500&orderBy=recorded_at&order=desc`;
      const rows = await fetch(url,{headers:H()}).then(r=>r.json());
      const latest = new Map();
      rows.forEach(r=>{ const k=r.technician_id; if(!latest.has(k)) latest.set(k, r); });
      const bounds = [];
      latest.forEach(r=>{
        if(r.lat==null || r.lng==null) return;
        const label = r.technicians?.full_name || ('Tech #'+r.technician_id);
        const m = L.marker([r.lat, r.lng]).bindPopup(`<strong>${label}</strong><br>${new Date(r.recorded_at).toLocaleString()}`);
        m.addTo(markerLayer); bounds.push([r.lat, r.lng]);
      });
      if(bounds.length) map.fitBounds(bounds, { padding:[20,20] });
    }

    // ---------------------- Settings -----------------------------------------
    document.getElementById('btnSettings').addEventListener('click', ()=>{
      const base = prompt('NocoDB Base API URL', localStorage.getItem('NC_BASE') || NC_BASE);
      if(base!==null) localStorage.setItem('NC_BASE', base.trim());
      const pat = prompt('Personal Access Token (PAT)', localStorage.getItem('NC_PAT') || NC_PAT);
      if(pat!==null) localStorage.setItem('NC_PAT', pat.trim());
      location.reload();
    });

    // ---------------------- Init ---------------------------------------------
    (async function init(){
      if(!NC_PAT) alert('Missing NocoDB PAT. Click ⚙️ Settings to set NC_BASE and NC_PAT.');
      await loadKPIs();
      await jobsPerTechChart();
      await loadUpcoming();
      await loadRecent();
      await loadTechLocations();
    })();
  </script>
</body>
</html>

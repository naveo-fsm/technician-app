<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Naveo FSM – Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="../assets/js/noco.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--primary:#0056b3;--bg:#f5f7fb;--card:#fff;--border:#e5e7eb}
    body{margin:0;background:var(--bg);font-family:Poppins, Arial, sans-serif}
    header{display:flex;justify-content:space-between;align-items:center;padding:14px 18px;background:var(--card);box-shadow:0 4px 18px rgba(0,0,0,.06)}
    h1{font-size:18px;margin:0}
    .container{padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.05);padding:16px;margin-bottom:16px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi h3{margin:0 0 6px;font-size:12px;color:#6b7280}
    .kpi div{font-size:28px;font-weight:700}
    @media(max-width:900px){ .kpis{grid-template-columns:repeat(2,1fr)} }
  </style>
</head>
<body>
  <header>
    <h1>Planner • Dashboard</h1>
    <div></div>
  </header>

  <div class="container">
    <section class="card">
      <h2 style="margin:0 0 10px;font-size:16px;">Today’s KPIs</h2>
      <div class="kpis">
        <div class="kpi"><h3>Completed</h3><div id="kpiCompleted">0</div></div>
        <div class="kpi"><h3>First-Time Fix</h3><div id="kpiFTF">0%</div></div>
        <div class="kpi"><h3>Utilization</h3><div id="kpiUtil">0%</div></div>
        <div class="kpi"><h3>In Progress</h3><div id="kpiInProg">0</div></div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 10px;">Jobs per Tech (Last 7 days)</h3>
      <canvas id="jobsPerTech"></canvas>
    </section>

    <section class="card">
      <h3 style="margin:0 0 10px;">FTF Trend (Last 14 days)</h3>
      <canvas id="ftfTrend"></canvas>
    </section>
  </div>

  <script>
    const { T } = NC, api = NCAPI, U = NCUTIL;

    function startOfDay(d){ const x = new Date(d); x.setHours(0,0,0,0); return x; }
    function daysAgo(n){ const x = new Date(); x.setDate(x.getDate()-n); return x; }

    async function fetchToday() {
      const from = startOfDay(new Date());
      const to = new Date();
      const qRange = `filter=(completed_at,between,${U.iso(from)},${U.iso(to)})`;

      const [completed, inProg, allCompleted, ftfCompleted, techs] = await Promise.all([
        api.list(T.service_orders, `filter=(status,eq,completed)&${qRange}`),
        api.list(T.service_orders, `filter=(status,eq,in_progress)`),
        api.list(T.service_orders, `filter=(status,eq,completed)&${qRange}&select=id,technician_id`),
        api.list(T.service_orders, `filter=(status,eq,completed)&filter=(return_visit_required,eq,false)&${qRange}&select=id`),
        api.list(T.technicians, 'limit=1000&select=id,full_name,shift_minutes')
      ]);

      document.getElementById('kpiCompleted').textContent = completed.list.length;
      document.getElementById('kpiInProg').textContent = inProg.list.length;

      const ftf = allCompleted.list.length ? Math.round((ftfCompleted.list.length / allCompleted.list.length) * 100) : 0;
      document.getElementById('kpiFTF').textContent = ftf + '%';

      // Simple utilization heuristic
      const techById = Object.fromEntries(techs.list.map(t => [t.id, t]));
      let totalCapacity = 0, totalJobs = 0;
      const jobsByTech = {};
      for (const so of allCompleted.list) {
        jobsByTech[so.technician_id] = (jobsByTech[so.technician_id] || 0) + 1;
      }
      Object.keys(jobsByTech).forEach(id => {
        const t = techById[id] || {};
        const shiftMin = +t.shift_minutes || 480;   // default 8h
        const avgJobMin = 60;                       // tune if you track true durations
        totalCapacity += Math.max(1, Math.floor(shiftMin / avgJobMin));
        totalJobs += jobsByTech[id];
      });
      const util = totalCapacity ? Math.round((totalJobs / totalCapacity) * 100) : 0;
      document.getElementById('kpiUtil').textContent = util + '%';
    }

    async function chartJobsPerTech() {
      const from = daysAgo(7), to = new Date();
      const res = await api.list(T.service_orders, `filter=(completed_at,between,${U.iso(from)},${U.iso(to)})&filter=(status,eq,completed)&select=id,technician_id`);
      const techs = await api.list(T.technicians, 'limit=1000&select=id,full_name');
      const name = (id)=> (techs.list.find(t=>t.id===id)?.full_name) || ('Tech #'+id);

      const counts = {};
      res.list.forEach(so => counts[so.technician_id] = (counts[so.technician_id]||0)+1);
      const labels = Object.keys(counts).map(id => name(+id));
      const data = Object.values(counts);

      const ctx = document.getElementById('jobsPerTech').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Completed Jobs', data }] },
        options: { responsive:true, plugins:{legend:{display:false}} }
      });
    }

    async function chartFtfTrend() {
      const days = [...Array(14)].map((_,i)=> i).reverse();
      const labels = days.map(d=> {
        const x = daysAgo(d); return `${x.getMonth()+1}/${x.getDate()}`;
      });

      const ftfPerc = [];
      for(const d of days){
        const day = daysAgo(d);
        const from = startOfDay(day), to = new Date(from); to.setDate(to.getDate()+1);
        const all = await api.list(T.service_orders, `filter=(status,eq,completed)&filter=(completed_at,between,${U.iso(from)},${U.iso(to)})`);
        const good = await api.list(T.service_orders, `filter=(status,eq,completed)&filter=(return_visit_required,eq,false)&filter=(completed_at,between,${U.iso(from)},${U.iso(to)})`);
        ftfPerc.push(all.list.length ? Math.round((good.list.length/all.list.length)*100) : 0);
      }

      const ctx = document.getElementById('ftfTrend').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: { labels, datasets: [{ label:'FTF %', data: ftfPerc, tension:.3 }]},
        options: { responsive:true, scales:{ y:{ suggestedMin:0, suggestedMax:100 }}}
      });
    }

    (async function init(){
      await fetchToday();
      await chartJobsPerTech();
      await chartFtfTrend();
    })();
  </script>
</body>
</html>

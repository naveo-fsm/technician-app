<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Naveo FSM — Dashboard</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Charts & Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Inline modern light theme CSS -->
  <style>
    :root{
      --bg:#f7f8fb; --surface:#ffffff; --surface-2:#f1f5f9; --surface-muted:#f6f8fb;
      --text:#0f172a; --text-muted:#64748b; --primary:#2563eb; --accent:#8b5cf6;
      --success:#16a34a; --warning:#f59e0b; --danger:#ef4444; --info:#0891b2;
      --border:rgba(2,6,23,.10);
      --radius-sm:8px; --radius-md:12px; --radius-lg:16px;
      --shadow-sm:0 2px 8px rgba(2,6,23,.06); --shadow-md:0 10px 24px rgba(2,6,23,.08); --shadow-lg:0 24px 48px rgba(2,6,23,.12);
      --space-1:4px; --space-2:8px; --space-3:12px; --space-4:16px; --space-5:20px; --space-6:24px; --space-7:28px; --space-8:32px;
      --text-sm:.875rem; --text-xs:.78rem;
    }

    *,*::before,*::after{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:400 16px/1.5 Poppins, ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    a{ color: var(--primary); text-decoration:none; } a:hover{ text-decoration:underline; }
    .muted{ color:var(--text-muted); } .text-sm{ font-size:var(--text-sm); } .hide{ display:none !important; }
    .grid{ display:grid; } .grid-2{ grid-template-columns: repeat(2, minmax(0,1fr)); gap: var(--space-6); }
    .grid-3{ grid-template-columns: repeat(3, minmax(0,1fr)); gap: var(--space-6); }
    .flex{ display:flex; } .items-center{ align-items:center; } .justify-between{ justify-content:space-between; }
    .gap-4{ gap: var(--space-4); } .mt-4{ margin-top: var(--space-4); }

    .topbar{
      position:sticky; top:0; z-index:40; display:flex; align-items:center; gap:12px; padding:12px 16px;
      background:linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.85));
      backdrop-filter:blur(6px); border-bottom:1px solid var(--border);
    }
    .topbar .title{ font-weight:700; letter-spacing:.2px; }

    /* Uniform sidebar with pinned Logout */
    .sidebar{
      position:fixed; inset:56px auto 0 0; width:240px; padding:16px; background:var(--surface);
      border-right:1px solid var(--border); overflow:auto; display:flex; flex-direction:column;
    }
    .sidebar .brand{ font-weight:700; margin-bottom:10px; }
    .sidebar a{ display:block; padding:10px 12px; border-radius:10px; color:inherit; text-decoration:none; }
    .sidebar a:hover{ background:var(--surface-2); }
    .sidebar a.active{
      background:linear-gradient(135deg, rgba(37,99,235,.12), rgba(139,92,246,.12));
      border:1px solid rgba(37,99,235,.35);
    }
    .sidebar .footer{ margin-top:auto; padding-top:8px; }
    .sidebar .logout{ width:100%; display:flex; justify-content:center; }

    .main{ margin-left:240px; padding:18px; }

    .card{ background:var(--surface); border:1px solid var(--border); border-radius:var(--radius-lg); box-shadow:var(--shadow-sm); }
    .card-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:var(--space-4) var(--space-5); border-bottom:1px solid var(--border); }
    .card-body{ padding:var(--space-5); }

    .toolbar{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .input,.select,.textarea{
      width:100%; padding:10px 12px; border:1px solid var(--border); background:#fff; color:var(--text);
      border-radius:10px; outline:none; transition:.12s ease;
    }
    .textarea{ min-height:96px; resize:vertical; }
    .input:focus,.select:focus,.textarea:focus{ border-color:rgba(37,99,235,.55); box-shadow:0 0 0 3px rgba(37,99,235,.20); }

    .btn{
      --bg:#fff; --bd:var(--border); --fg:var(--text);
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px;
      border:1px solid var(--bd); background:var(--bg); color:var(--fg);
      border-radius:10px; cursor:pointer; user-select:none; transition:.15s ease;
    }
    .btn:hover{ filter:brightness(1.02); box-shadow:var(--shadow-sm); }
    .btn:active{ transform:translateY(1px); }
    .btn-sm{ padding:6px 10px; font-size:var(--text-sm); border-radius:8px; }
    .btn-primary{ --bg:linear-gradient(135deg, var(--primary), var(--accent)); --bd:rgba(2,6,23,.12); --fg:#fff; color:#fff; }
    .btn-outline{ --bg:#fff; --bd:rgba(2,6,23,.18); }
    .btn-danger{ --bg:#fff; --bd:rgba(239,68,68,.4); color:var(--danger); }

    .table-wrap{ overflow:auto; border:1px solid var(--border); border-radius:12px; }
    table.table{ width:100%; border-collapse:collapse; }
    .table thead th{ background:var(--surface-muted); color:var(--text-muted); font-weight:600; text-align:left; padding:12px; border-bottom:1px solid var(--border); white-space:nowrap; }
    .table tbody td{ padding:12px; border-bottom:1px solid var(--border); vertical-align:top; }
    .table tbody tr:hover{ background:#fafbff; }

    .badge{ display:inline-block; padding:4px 8px; border-radius:999px; background:#fff; border:1px solid var(--border); font-size:var(--text-sm); }
    .badge.success{ background:rgba(22,163,74,.10); border-color:rgba(22,163,74,.35); color:#065f46; }
    .badge.warning{ background:rgba(245,158,11,.10); border-color:rgba(245,158,11,.35); color:#92400e; }
    .badge.info{ background:rgba(8,145,178,.10); border-color:rgba(8,145,178,.35); color:#0c4a6e; }

    .badge.status-assigned{ background:rgba(99,102,241,.12); border-color:rgba(99,102,241,.35); color:#3730a3; }
    .badge.status-in_progress{ background:rgba(2,132,199,.12); border-color:rgba(2,132,199,.35); color:#075985; }
    .badge.status-completed{ background:rgba(22,163,74,.12); border-color:rgba(22,163,74,.35); color:#065f46; }
    .badge.status-cancelled{ background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35); color:#7f1d1d; }

    .badge.priority-low{ background:rgba(148,163,184,.12); border-color:rgba(148,163,184,.35); color:#334155; }
    .badge.priority-normal{ background:rgba(37,99,235,.10); border-color:rgba(37,99,235,.35); color:#1e3a8a; }
    .badge.priority-high{ background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.35); color:#92400e; }
    .badge.priority-urgent{ background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35); color:#7f1d1d; }

    .kpi{ display:grid; grid-template-columns: repeat(5,minmax(0,1fr)); gap: var(--space-6); }
    .kpi-item{ padding:14px 16px; background:var(--surface); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow-sm); }
    .kpi-label{ color:var(--text-muted); font-size:var(--text-sm); }
    .kpi-value{ font-weight:700; font-size: 1.6rem; margin-top:6px; }
    .kpi .kpi-delta{ font-size:var(--text-sm); color:var(--text-muted); }

    .map-container{ height:320px; width:100%; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:var(--surface); }
    #map{ height:100%; width:100%; }

    .pagination{ display:flex; gap:8px; }
    .page{ display:inline-flex; align-items:center; justify-content:center; width:38px; height:38px; border:1px solid var(--border); border-radius:10px; color:inherit; text-decoration:none; }
    .page.active{ background:#eef2ff; border-color:rgba(37,99,235,.45); color:#1e3a8a; }

    @media (max-width: 1200px){ .kpi{ grid-template-columns: repeat(2,minmax(0,1fr)); } }
    @media (max-width: 760px){
      .sidebar{ position:static; width:auto; display:flex; gap:8px; border-right:0; border-bottom:1px solid var(--border); }
      .main{ margin-left:0; }
      .kpi{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="title">Naveo FSM</div>
    <span class="muted">Dashboard</span>
    <div style="flex:1 1 auto"></div>
    <button class="btn" id="btnSettings" title="NocoDB settings">⚙️ API Settings</button>
  </div>

  <!-- Uniform sidebar with pinned Logout -->
  <aside class="sidebar">
    <div class="brand">Naveo</div>
    <a class="active" href="dashboard.html">Dashboard</a>
    <a href="planner-jobs.html">Service Orders</a>
    <a href="assign-job-enhanced.html">Assign Job</a>
    <a href="assign-inventory-selector.html">Assign Inventory</a>
    <a href="planner-inventory.html">Inventory</a>
    <a href="reports.html">Reports</a>
    <a href="realtime-map.html">Live Map</a>
    <a href="admin-intervention-master.html">Admin · Intervention Types</a>
    <a href="admin-tech-master.html">Admin · Technicians</a>
    <div class="footer">
      <button class="btn logout" id="btnLogout">Log out</button>
    </div>
  </aside>

  <main class="main">
    <!-- KPIs -->
    <div class="kpi">
      <div class="kpi-item"><div class="kpi-label">Open (assigned)</div><div class="kpi-value" id="kpiOpen">0</div></div>
      <div class="kpi-item"><div class="kpi-label">In Progress</div><div class="kpi-value" id="kpiInProg">0</div></div>
      <div class="kpi-item"><div class="kpi-label">Completed Today</div><div class="kpi-value" id="kpiDone">0</div></div>
      <div class="kpi-item"><div class="kpi-label">Overdue</div><div class="kpi-value" id="kpiOverdue">0</div></div>
      <div class="kpi-item">
        <div class="kpi-label">First-Time Fix (today)</div>
        <div class="kpi-value" id="kpiFTF">0%</div>
        <div class="kpi-delta" id="kpiFTFNote" style="margin-top:4px"></div>
      </div>
    </div>

    <div class="grid grid-2 mt-4" style="gap: var(--space-6)">
      <!-- Left: Charts & Recent -->
      <div class="grid" style="gap: var(--space-6)">
        <div class="card chart-card">
          <div class="card-header">
            <h3>Jobs per Technician (today)</h3>
            <div class="text-sm muted">Scheduled for today</div>
          </div>
          <div class="card-body">
            <canvas id="chartJobsPerTech"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><h3>Upcoming Jobs (next 7 days)</h3></div>
          <div class="card-body">
            <div class="table-wrap">
              <table class="table" id="tblUpcoming">
                <thead>
                  <tr>
                    <th>When</th>
                    <th>SO</th>
                    <th>Technician</th>
                    <th>Type</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th class="text-right">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><h3>Recent Activity</h3></div>
          <div class="card-body">
            <div id="recentList" class="grid" style="gap:12px"></div>
          </div>
        </div>
      </div>

      <!-- Right: Map & quick links -->
      <div class="grid" style="gap: var(--space-6)">
        <div class="card">
          <div class="card-header"><h3>Live Technicians</h3><div class="text-sm muted">Last known location</div></div>
          <div class="card-body">
            <div id="map" class="map-container"></div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><h3>Quick Actions</h3></div>
          <div class="card-body">
            <div class="grid grid-2" style="gap:12px">
              <a class="btn btn-primary" href="assign-job-enhanced.html">＋ New Service Order</a>
              <a class="btn" href="planner-jobs.html">View All Jobs</a>
              <a class="btn" href="planner-inventory.html">Manage Inventory</a>
              <a class="btn" href="admin-tech-master.html">Manage Technicians</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ---------------------- Hard-coded API config -----------------------------
    const NC_BASE = 'https://app.nocodb.com/api/v2';
    const NC_PAT  = '7x7ZxLedCtJSWtiD4dNOu9sB7JlEFB8JiVe0TpRh';

    const TBL_SO   = 'm2dmcyfy30klv76';   // service_orders
    const TBL_TECH = 'mzw1focsec0tekg';   // technicians
    const TBL_INT  = 'mb4yox88hd24r0h';   // intervention_types
    const TBL_TLOC = 'mdau1eojkb8c56x';   // technician_locations
    const TBL_SOSH = 'mirdk2w4yjcny1b';   // service_order_status_history

    const H = () => ({ 'Content-Type': 'application/json', 'xc-token': NC_PAT });
    const $ = (s, p=document) => p.querySelector(s);

    // Logout clears any overrides and redirects (optional)
    function logout(){ try{ localStorage.removeItem('NC_BASE'); localStorage.removeItem('NC_PAT'); }catch(e){} location.href='login.html'; }

    // ---------------------- Date helpers -------------------------------------
    function startOfTodayISO(){ const d=new Date(); d.setHours(0,0,0,0); return d.toISOString().slice(0,19); }
    function endOfTodayISO(){ const d=new Date(); d.setHours(23,59,59,999); return new Date(d - d.getTimezoneOffset()*60000).toISOString().slice(0,19); }
    function nowISO(){ return new Date().toISOString().slice(0,19); }
    function inDaysISO(days){ const d=new Date(Date.now()+days*86400000); return d.toISOString().slice(0,19); }

    // ---------------------- KPI counts ---------------------------------------
    async function countSO(where){
      let url = `${NC_BASE}/tables/${TBL_SO}/records/count`;
      if(where) url += `?where=${encodeURIComponent(where)}`;
      const r = await fetch(url,{headers:H()}); if(!r.ok) return 0; const j = await r.json(); return j?.count||0;
    }

    async function loadKPIs(){
      const open = await countSO('(status,eq,assigned)');
      const inprog = await countSO('(status,eq,in_progress)');
      const doneToday = await countSO(`(status,eq,completed)~and(completed_at,ge,${startOfTodayISO()})`);
      const overdue = await countSO(`(scheduled_at,lt,${nowISO()})~and(status,neq,completed)~and(status,neq,cancelled)`);

      $('#kpiOpen').textContent = open;
      $('#kpiInProg').textContent = inprog;
      $('#kpiDone').textContent = doneToday;
      $('#kpiOverdue').textContent = overdue;

      const ftfNum = await countSO(`(status,eq,completed)~and(completed_at,ge,${startOfTodayISO()})~and(return_visit_required,eq,false)`);
      const ftf = doneToday ? Math.round(100 * ftfNum / doneToday) : 0;
      $('#kpiFTF').textContent = ftf + '%';
      $('#kpiFTFNote').textContent = `${ftfNum}/${doneToday} first-time fixes`;
    }

    // ---------------------- Jobs per Technician (today) ----------------------
    async function jobsPerTechChart(){
      const where = `(scheduled_at,ge,${startOfTodayISO()})~and(scheduled_at,le,${endOfTodayISO()})`;
      const url = `${NC_BASE}/tables/${TBL_SO}/records?limit=10000&where=${encodeURIComponent(where)}`;
      const rows = await fetch(url,{headers:H()}).then(r=>r.json());
      const counts = new Map();
      rows.forEach(r=>{
        const k = r.technicians?.full_name || r.technician_id || 'Unassigned';
        counts.set(k, (counts.get(k)||0)+1);
      });
      const labels = Array.from(counts.keys());
      const data = Array.from(counts.values());
      const ctx = document.getElementById('chartJobsPerTech').getContext('2d');
      new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Jobs', data }] },
        options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
      });
    }

    // ---------------------- Upcoming (next 7 days) ---------------------------
    async function loadUpcoming(){
      const where = `(scheduled_at,ge,${nowISO()})~and(scheduled_at,le,${inDaysISO(7)})`;
      const url = `${NC_BASE}/tables/${TBL_SO}/records?limit=25&orderBy=scheduled_at&order=asc&where=${encodeURIComponent(where)}`;
      const rows = await fetch(url,{headers:H()}).then(r=>r.json());
      const tbody = document.querySelector('#tblUpcoming tbody'); tbody.innerHTML='';
      rows.forEach(r=>{
        const pr = (r.priority||'normal').toLowerCase();
        const st = (r.status||'assigned').toLowerCase();
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.scheduled_at ? new Date(r.scheduled_at).toLocaleString() : ''}</td>
          <td class="mono">${r.so_id || r.id}</td>
          <td>${r.technicians?.full_name || r.technician_id || ''}</td>
          <td>${r.intervention_types?.intervention_name || r.intervention_type_id || ''}</td>
          <td><span class="badge priority-${pr}">${pr}</span></td>
          <td><span class="badge status-${st}">${st}</span></td>
          <td class="text-right"><a class="btn btn-sm" href="assign-inventory-selector.html?so=${encodeURIComponent(r.id)}">Assign inventory</a></td>`;
        tbody.appendChild(tr);
      });
    }

    // ---------------------- Recent Activity ----------------------------------
    async function loadRecent(){
      const url = `${NC_BASE}/tables/${TBL_SOSH}/records?limit=10&orderBy=changed_at&order=desc`;
      const rows = await fetch(url,{headers:H()}).then(r=>r.json());
      const list = document.getElementById('recentList'); list.innerHTML='';

      // Map SO ids to rows for labels
      const ids = [...new Set(rows.map(r=>r.service_order_id).filter(Boolean))];
      const soMap = new Map();
      if(ids.length){
        const idList = ids.join(',');
        const soUrl = `${NC_BASE}/tables/${TBL_SO}/records?limit=${ids.length}&where=${encodeURIComponent(`(id,in,${idList})`)}`;
        const sos = await fetch(soUrl,{headers:H()}).then(r=>r.json());
        sos.forEach(s=> soMap.set(s.id, s));
      }

      rows.forEach(r=>{
        const so = soMap.get(r.service_order_id);
        const soLabel = so ? (so.so_id || so.id) : r.service_order_id;
        const who = r.users?.full_name || r.user_id || 'system';
        const item = document.createElement('div');
        item.style.display='flex';
        item.style.alignItems='center';
        item.style.justifyContent='space-between';
        item.style.gap='12px';
        item.style.border='1px solid var(--border)';
        item.style.background='var(--surface)';
        item.style.borderRadius='var(--radius-md)';
        item.style.padding='10px 12px';
        item.innerHTML = `
          <div>
            <div><span class="badge status-${r.status}">${r.status}</span> <span class="mono">${soLabel}</span></div>
            <div class="text-sm muted">by ${who} · ${new Date(r.changed_at).toLocaleString()}</div>
          </div>
          <a class="btn btn-sm" href="planner-jobs.html">Open</a>`;
        list.appendChild(item);
      });
    }

    // ---------------------- Map ----------------------------------------------
    let map, markerLayer;
    function ensureMap(){
      if(map) return map;
      map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap' }).addTo(map);
      markerLayer = L.layerGroup().addTo(map);
      map.setView([-20.2, 57.5], 9); // default view
      return map;
    }

    async function loadTechLocations(){
      ensureMap(); markerLayer.clearLayers();
      const url = `${NC_BASE}/tables/${TBL_TLOC}/records?limit=500&orderBy=recorded_at&order=desc`;
      const rows = await fetch(url,{headers:H()}).then(r=>r.json());
      const latest = new Map();
      rows.forEach(r=>{ const k=r.technician_id; if(!latest.has(k)) latest.set(k, r); });
      const bounds = [];
      latest.forEach(r=>{
        if(r.lat==null || r.lng==null) return;
        const label = r.technicians?.full_name || ('Tech #'+r.technician_id);
        const m = L.marker([r.lat, r.lng]).bindPopup(`<strong>${label}</strong><br>${new Date(r.recorded_at).toLocaleString()}`);
        m.addTo(markerLayer); bounds.push([r.lat, r.lng]);
      });
      if(bounds.length) map.fitBounds(bounds, { padding:[20,20] });
    }

    // ---------------------- Settings & Logout --------------------------------
    document.getElementById('btnSettings').addEventListener('click', ()=>{
      alert('Demo credentials are hard-coded.\nAPI: '+NC_BASE+'\nPAT: '+NC_PAT.slice(0,6)+'…');
    });
    document.getElementById('btnLogout').addEventListener('click', logout);

    // ---------------------- Init ---------------------------------------------
    (async function init(){
      await loadKPIs();
      await jobsPerTechChart();
      await loadUpcoming();
      await loadRecent();
      await loadTechLocations();
    })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Assign Inventory | Naveo FSM Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary: #007bff;
      --primary-dark: #0056b3;
      --success: #28a745;
      --danger: #dc3545;
      --bg: #f5f7fa;
      --card-bg: #fff;
      --radius: 8px;
      --spacing: 1rem;
      --text: #333;
      --border: #e0e0e0;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: var(--spacing);
    }
    h2 {
      text-align: center;
      color: var(--primary);
      margin-bottom: var(--spacing);
      font-size: 1.5rem;
    }
    form {
      background: var(--card-bg);
      padding: var(--spacing);
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-width: 900px;
      margin: 0 auto;
    }
    .form-group {
      margin-bottom: var(--spacing);
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 1rem;
    }
    input:focus, select:focus { outline: none; border-color: var(--primary); }
    .table-container {
      overflow-x: auto;
      margin-bottom: var(--spacing);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
      border-radius: var(--radius);
      overflow: hidden;
    }
    th, td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border);
      text-align: left;
      font-size: 0.95rem;
    }
    th {
      background: var(--primary);
      color: #fff;
      font-weight: 600;
    }
    tr:nth-child(even) td { background: #f9f9f9; }
    .btn {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: var(--radius);
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s;
      margin-right: 0.5rem;
    }
    .btn-add {
      background: var(--primary);
      color: #fff;
    }
    .btn-add:hover { background: var(--primary-dark); }
    .btn-submit {
      background: var(--success);
      color: #fff;
    }
    .btn-submit:hover { background: #218838; }
    .btn-danger {
      background: var(--danger);
      color: #fff;
    }
    .btn-danger:hover { background: #c82333; }
    .debug {
      margin-top: var(--spacing);
      font-family: monospace;
      background: #eee;
      padding: 0.5rem;
      border-radius: var(--radius);
      max-height: 150px;
      overflow: auto;
    }
    @media (max-width: 600px) {
      table, th, td { font-size: 0.85rem; }
      .btn { width: 100%; margin-bottom: 0.5rem; }
      .btn-add { margin-bottom: var(--spacing); }
    }
  </style>
  <script src="../assets/js/auth.js"></script>
  <script>
    const INVENTORY_MASTER_URL = 'https://sheetdb.io/api/v1/xg2dgvssxzvag/Stock_Master';
    const SERVICE_INV_URL      = 'https://sheetdb.io/api/v1/xg2dgvssxzvag/ServiceOrderInventory';
    let inventoryMaster = [];
    function log(msg) {
      document.getElementById('debug').textContent += msg + '\n';
    }
    document.addEventListener('DOMContentLoaded', async () => {
      if (localStorage.getItem('userRole') !== 'planner') {
        alert('Access denied'); location.href='../login.html'; return;
      }
      try {
        const res = await fetch(INVENTORY_MASTER_URL);
        inventoryMaster = await res.json();
        log(`Loaded ${inventoryMaster.length} master items`);
        addRow();
      } catch (e) {
        alert('Error loading inventory master:'+e);
        log('ERR loadInv:'+e);
      }
    });
    function addRow() {
      const tbody = document.querySelector('#invTable tbody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><select class="masterSelect"><option value="">-- select item --</option>$
          {inventoryMaster.map(item=>
            `<option value="${item.id}" data-make="${item.Make}" data-model="${item.Model}"
              data-serial="${item.SerialNumber}" data-sim="${item.SIMNumber}">
              ${item.Make} ${item.Model}</option>`).join('')}
        </select></td>
        <td><input class="inp-make"   type="text" readonly /></td>
        <td><input class="inp-model"  type="text" readonly /></td>
        <td><input class="inp-serial" type="text" readonly /></td>
        <td><input class="inp-sim"    type="text" readonly /></td>
        <td><button type="button" class="btn btn-danger" onclick="removeRow(this)">Remove</button></td>`;
      tbody.appendChild(tr);
      const sel = tr.querySelector('.masterSelect');
      sel.addEventListener('change', e => {
        const opt = sel.selectedOptions[0];
        tr.querySelector('.inp-make').value   = opt.dataset.make   || '';
        tr.querySelector('.inp-model').value  = opt.dataset.model  || '';
        tr.querySelector('.inp-serial').value = opt.dataset.serial || '';
        tr.querySelector('.inp-sim').value    = opt.dataset.sim    || '';
      });
    }
    function removeRow(btn) { btn.closest('tr').remove(); }
    async function submitInventory(e) {
      e.preventDefault();
      const so_id = document.getElementById('soId').value.trim() || localStorage.getItem('currentSO');
      if (!so_id) { alert('Service Order ID is required'); return; }
      const rows = Array.from(document.querySelectorAll('#invTable tbody tr'));
      const payload = rows.map(tr=>{
        const sel = tr.querySelector('.masterSelect');
        return { so_id, master_id: sel.value,
          Make: tr.querySelector('.inp-make').value,
          Model: tr.querySelector('.inp-model').value,
          Serial: tr.querySelector('.inp-serial').value,
          SIM: tr.querySelector('.inp-sim').value };
      }).filter(r=>r.master_id);
      if (!payload.length) { alert('Select at least one item.'); return; }
      log('Posting '+payload.length+' items...');
      try {
        const res = await fetch(SERVICE_INV_URL, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ data: payload })
        });
        if (!res.ok) throw new Error(res.statusText);
        alert('Inventory assigned successfully!');
        document.querySelector('#invTable tbody').innerHTML=''; addRow();
      } catch(err) {
        alert('Error submitting:'+err);
        log('ERR submit:'+err);
      }
    }
  </script>
</head>
<body>
  <h2>Assign Inventory to Service Order</h2>
  <form onsubmit="submitInventory(event)">
    <div class="form-group">
      <label for="soId">Service Order ID</label>
      <input id="soId" placeholder="Enter or use existing SO ID" />
    </div>
    <div class="table-container">
      <table id="invTable">
        <thead>
          <tr>
            <th>Item</th><th>Make</th><th>Model</th><th>Serial#</th><th>SIM#</th><th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <button type="button" class="btn btn-add" onclick="addRow()">＋ Add Another</button>
    <button type="submit" class="btn btn-submit">✅ Submit Inventory</button>
  </form>
  <pre id="debug" class="debug"></pre>
</body>
</html>

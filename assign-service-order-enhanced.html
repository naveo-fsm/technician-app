
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Planner - Service Order (Enhanced)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; }
    input, select, textarea { padding: 0.5rem; margin-bottom: 1rem; width: 100%; max-width: 500px; }
    label { font-weight: bold; margin-top: 1rem; display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; }
    th { background: #003366; color: white; }
    button { padding: 0.6rem 1rem; margin-top: 1rem; }
  </style>
</head>
<body>
<h2>üìã Assign Multi-Vehicle Service Order</h2>

<label>Service Order No:</label><input id="soNumber" required />
<label>Intervention Type:</label><input id="interventionType" required />
<label>Lead Technician:</label>
<select id="leadTech"><option value="">-- Select --</option></select>
<label>Additional Workers:</label><input id="workers" placeholder="Comma-separated names" />
<label>Start Date:</label><input type="date" id="startDate" />
<label>Special Notes:</label><textarea id="notes"></textarea>

<h3>üöó Vehicles Involved</h3>
<table id="vehicleTable">
  <thead><tr><th>Vehicle No</th><th>Checklist</th><th>Inventory (e.g. Cable:2,Box:1)</th><th>Remarks</th><th>Action</th></tr></thead>
  <tbody></tbody>
</table>
<button onclick="addVehicle()">+ Add Vehicle</button>
<button onclick="submitOrder()">‚úÖ Submit Service Order</button>
<button onclick="window.print()">üñ® Print</button>

<hr>
<h2>üìë Service Order Viewer</h2>
<table id="viewTable"><thead>
<tr><th>SO No</th><th>Vehicle</th><th>Checklist</th><th>Item</th><th>Qty</th><th>Remarks</th></tr>
</thead><tbody></tbody></table>

<script>
const techList = ["John", "Sarah", "Ali", "Fatima"];

function populateTechs() {
  const sel = document.getElementById("leadTech");
  techList.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t; opt.text = t;
    sel.appendChild(opt);
  });
}

function addVehicle() {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td><input placeholder='e.g. MZ-4521' /></td>
    <td><input placeholder='Checklist Type' /></td>
    <td><input placeholder='Item1:2,Item2:1' /></td>
    <td><input /></td>
    <td><button onclick="this.parentNode.parentNode.remove()">‚ùå</button></td>
  `;
  document.querySelector("#vehicleTable tbody").appendChild(row);
}

async function submitOrder() {
  const so = document.getElementById("soNumber").value;
  const intervention = document.getElementById("interventionType").value;
  const lead = document.getElementById("leadTech").value;
  const workers = document.getElementById("workers").value;
  const start = document.getElementById("startDate").value;
  const notes = document.getElementById("notes").value;
  const rows = Array.from(document.querySelectorAll("#vehicleTable tbody tr"));
  const allData = [];

  rows.forEach(row => {
    const inputs = row.querySelectorAll("input");
    const veh = inputs[0].value;
    const checklist = inputs[1].value;
    const inventory = inputs[2].value;
    const remark = inputs[3].value;

    if (inventory.includes(":")) {
      inventory.split(",").forEach(itemQty => {
        const [item, qty] = itemQty.split(":");
        allData.push({
          ServiceOrder: so,
          VehicleNo: veh,
          Checklist: checklist,
          InventoryItem: item.trim(),
          Quantity: qty.trim(),
          Remarks: remark,
          InterventionType: intervention,
          LeadTech: lead,
          AdditionalWorkers: workers,
          StartDate: start,
          Notes: notes
        });
      });
    } else {
      allData.push({
        ServiceOrder: so,
        VehicleNo: veh,
        Checklist: checklist,
        InventoryItem: inventory,
        Quantity: 1,
        Remarks: remark,
        InterventionType: intervention,
        LeadTech: lead,
        AdditionalWorkers: workers,
        StartDate: start,
        Notes: notes
      });
    }
  });

  const res = await fetch("https://sheetdb.io/api/v1/xg2dgvssxzvag", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ data: allData })
  });
  alert("‚úÖ Service Order submitted!");
  window.location.reload();
}

async function loadViewer() {
  const res = await fetch("https://sheetdb.io/api/v1/xg2dgvssxzvag");
  const data = await res.json();
  const viewBody = document.querySelector("#viewTable tbody");
  data.filter(d => d.ServiceOrder).forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.ServiceOrder}</td><td>${d.VehicleNo}</td><td>${d.Checklist}</td>
      <td>${d.InventoryItem || ""}</td><td>${d.Quantity || ""}</td><td>${d.Remarks || ""}</td>
    `;
    viewBody.appendChild(tr);
  });
}

populateTechs();
addVehicle();
loadViewer();
</script>
</body>
</html>

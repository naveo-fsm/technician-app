
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Technician Checklist</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: Arial, sans-serif; padding: 2rem; background: #f2f2f2; }
    .section { margin-bottom: 2rem; background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    label { display: block; font-weight: bold; margin-top: 0.8rem; }
    select, input, textarea { width: 100%; padding: 0.5rem; margin-bottom: 1rem; border-radius: 5px; border: 1px solid #ccc; }
    .btn { padding: 0.6rem 1.2rem; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .btn:hover { background: #218838; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>

  <div class="section">
    <h2>ðŸš— Job Details</h2>
    <p><b>Vehicle:</b> <span id="vehicleNo"></span></p>
    <p><b>Intervention Type:</b> <span id="interventionType"></span></p>
  </div>

  <div class="section">
    <h2>ðŸ“‹ Checklist</h2>
    <table id="checklistTable">
      <thead>
        <tr><th>Task</th><th>Status</th><th>Notes</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>ðŸ“¦ Inventory Used</h2>
    <label>Inventory String</label>
    <textarea id="inventoryRaw" placeholder="e.g., Modem(SN1234), Sim(87654321)"></textarea>
    <button class="btn" onclick="parseInventory()">Parse Inventory</button>
    <table id="parsedInventory">
      <thead><tr><th>Item</th><th>Serial</th><th>SIM</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <button class="btn" onclick="submitForm()">âœ… Submit to SheetDB</button>

  <script>
    const checklistByType = {
      Installation: ["Mount device", "Connect power", "Test connection"],
      Maintenance: ["Clean device", "Firmware update", "Inspect casing"],
      Repair: ["Diagnose fault", "Replace parts", "Revalidate system"]
    };

    function loadChecklist(intervention) {
      const tasks = checklistByType[intervention] || [];
      const tbody = document.querySelector("#checklistTable tbody");
      tbody.innerHTML = "";
      tasks.forEach(task => {
        tbody.innerHTML += `
          <tr>
            <td>${task}</td>
            <td>
              <select>
                <option value="Done">Done</option>
                <option value="Pending">Pending</option>
              </select>
            </td>
            <td><input type="text" placeholder="Note"/></td>
          </tr>`;
      });
    }

    function parseInventory() {
      const raw = document.getElementById("inventoryRaw").value;
      const parts = raw.split(",");
      const tbody = document.querySelector("#parsedInventory tbody");
      tbody.innerHTML = "";
      parts.forEach(p => {
        const match = p.match(/(\w+)(\(([^\)]+)\))?/);
        if (match) {
          const item = match[1] || "";
          const code = match[3] || "";
          const isSim = code.length === 8 && /^\d+$/.test(code);
          tbody.innerHTML += `<tr>
            <td>${item}</td>
            <td>${isSim ? "" : code}</td>
            <td>${isSim ? code : ""}</td>
          </tr>`;
        }
      });
    }

    function submitForm() {
      const job = JSON.parse(localStorage.getItem("selectedJob") || "{}");
      const checklistRows = document.querySelectorAll("#checklistTable tbody tr");
      const parsedRows = document.querySelectorAll("#parsedInventory tbody tr");

      const checklistData = [];
      checklistRows.forEach(row => {
        const cells = row.querySelectorAll("td");
        checklistData.push({
          task: cells[0].innerText,
          status: cells[1].querySelector("select").value,
          notes: cells[2].querySelector("input").value
        });
      });

      const inventoryData = [];
      parsedRows.forEach(row => {
        const cells = row.querySelectorAll("td");
        inventoryData.push({
          item: cells[0].innerText,
          serial: cells[1].innerText,
          sim: cells[2].innerText
        });
      });

      const payload = {
        VehicleNo: job.VehicleNo,
        TechnicianID: job.TechnicianID,
        InterventionID: job.InterventionID,
        Checklist: JSON.stringify(checklistData),
        InventoryUsed: JSON.stringify(inventoryData)
      };

      fetch("https://sheetdb.io/api/v1/xg2dgvssxzvag", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ data: [payload] })
      })
      .then(res => res.json())
      .then(data => {
        alert("Submitted to SheetDB!");
        window.location.href = "technician.html";
      });
    }

    // On page load
    const job = JSON.parse(localStorage.getItem("selectedJob") || "{}");
    document.getElementById("vehicleNo").innerText = job.VehicleNo || "N/A";
    document.getElementById("interventionType").innerText = job.InterventionID || "N/A";
    loadChecklist(job.InterventionID || "Installation");
  </script>
</body>
</html>
